<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gerenciador de Ativos</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#005C73">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --black: #000000; --tiffany-blue: #96D1D3; --midnight-green: #005C73; --teal: #01848C; --white: #f0f8ff; --shadow: rgba(0, 0, 0, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--midnight-green); color: var(--white); line-height: 1.6; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; background-color: rgba(1, 132, 140, 0.2); border-radius: 15px; box-shadow: 0 10px 30px var(--shadow); padding: 25px; backdrop-filter: blur(5px); }
        header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--tiffany-blue); padding-bottom: 15px; }
        header h1 { color: var(--tiffany-blue); font-size: 2.5rem; text-shadow: 1px 1px 3px var(--black); }
        .actions-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .btn, .btn-like-input-label { background: var(--teal); color: var(--white); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 10px var(--shadow); display: inline-block; text-align: center; }
        .btn:hover, .btn-like-input-label:hover { background: var(--tiffany-blue); color: var(--midnight-green); transform: translateY(-2px); box-shadow: 0 6px 15px var(--shadow); }
        .btn-edit { background-color: var(--tiffany-blue); color: var(--midnight-green); } .btn-edit:hover { background-color: #b0e0e6; color: var(--black); }
        .btn-danger { background-color: #c0392b; } .btn-danger:hover { background-color: #e74c3c; }
        .btn-secondary { background-color: #7f8c8d; } .btn-secondary:hover { background-color: #95a5a6; }
        input[type="file"] { display: none; }
        .tabs { display: flex; border-bottom: 2px solid var(--teal); margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; background: none; border: none; color: var(--tiffany-blue); font-size: 1.1rem; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab-button.active { color: var(--white); border-bottom-color: var(--tiffany-blue); }
        .tab-content { display: none; animation: fadeIn 0.5s; } .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #asset-form, #bulk-edit-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; color: var(--tiffany-blue); font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea, .search-input { width: 100%; padding: 10px; border: 1px solid var(--teal); background-color: rgba(0, 92, 115, 0.5); color: var(--white); border-radius: 5px; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus, .search-input:focus { outline: none; border-color: var(--tiffany-blue); box-shadow: 0 0 10px rgba(150, 209, 211, 0.5); }
        #image-preview-container { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; }
        #image-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        #image-preview { max-width: 150px; max-height: 150px; border-radius: 5px; border: 1px dashed var(--teal); display: none; }
        .form-actions { grid-column: 1 / -1; text-align: right; display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .section-title { grid-column: 1 / -1; color: var(--tiffany-blue); border-bottom: 1px solid var(--teal); padding-bottom: 5px; margin-top: 20px; font-size: 1.2rem; }
        .table-container { overflow-x: auto; }
        #asset-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #asset-table th, #asset-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--midnight-green); white-space: nowrap; }
        #asset-table th.hidden, #asset-table td.hidden { display: none; }
        #asset-table th:first-child, #asset-table td:first-child { text-align: center; }
        .asset-image-thumbnail { max-width: 60px; max-height: 60px; border-radius: 5px; cursor: pointer; transition: transform 0.2s; }
        .asset-image-thumbnail:hover { transform: scale(1.1); }
        #camera-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; flex-direction: column; gap: 20px; }
        #camera-feed { max-width: 80%; max-height: 70%; border-radius: 10px; }
        .modal-buttons { display: flex; gap: 20px; }
        .conditional-fields { display: none; grid-column: 1 / -1; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; border: 1px dashed var(--teal); padding: 15px; border-radius: 8px; margin-top: 10px; }
        .conditional-fields.visible { display: grid; }
        .choices { width: 100%; }
        .choices__inner { background-color: rgba(0, 92, 115, 0.5); border: 1px solid var(--teal); border-radius: 5px; padding: 7px; font-size: 1rem; color: var(--white); min-height: 44px; }
        .choices.is-open .choices__inner { border-color: var(--tiffany-blue); }
        .choices__list--dropdown { background-color: var(--midnight-green); border-color: var(--teal); }
        .choices__item--choice { color: var(--white); }
        .choices__item--choice.is-highlighted { background-color: var(--tiffany-blue); color: var(--midnight-green); }
        .choices__item--selectable { background-color: var(--teal); border: 1px solid var(--tiffany-blue); }
        .choices__button { border-left: 1px solid rgba(255, 255, 255, 0.5); filter: invert(1); opacity: 0.75; }
        .choices__placeholder { color: var(--tiffany-blue); opacity: 0.8; }
        .choices[data-type*="select-one"]::after { border-color: var(--white) transparent transparent; }
        .choices.is-open[data-type*="select-one"]::after { border-color: transparent transparent var(--white); margin-top: -2.5px; }
        #exit-toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--black); color: var(--white); padding: 12px 25px; border-radius: 25px; font-size: 0.9rem; z-index: 2000; transition: bottom 0.4s ease-in-out; box-shadow: 0 5px 15px var(--shadow); }
        #exit-toast.show { bottom: 30px; }
        .list-controls { display: flex; gap: 10px; align-items: stretch; margin-bottom: 20px; flex-wrap: wrap; }
        .search-group { display: flex; flex-grow: 1; }
        #search-column { border-radius: 8px 0 0 8px; background: var(--teal); color: var(--white); border: 1px solid var(--teal); padding: 0 10px; font-weight: bold; }
        #search-column:focus { outline: none; }
        #search-input { border-radius: 0 8px 8px 0; border-left: none; }
        #bulk-delete-btn, #bulk-edit-btn { display: none; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: var(--midnight-green); border: 1px solid var(--tiffany-blue); min-width: 220px; box-shadow: 0 8px 16px 0 var(--shadow); border-radius: 8px; padding: 12px 16px; z-index: 1; right: 0; }
        .dropdown-content label { display: block; color: var(--white); margin-bottom: 8px; cursor: pointer; }
        .dropdown-content label:hover { color: var(--tiffany-blue); }
        .dropdown-content input { margin-right: 10px; }
        .show { display: block; }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--midnight-green); margin: 5% auto; padding: 30px; border: 1px solid var(--teal); border-radius: 15px; width: 90%; max-width: 900px; box-shadow: 0 10px 30px var(--shadow); position: relative; animation: fadeIn 0.5s; }
        .modal-content h2 { color: var(--tiffany-blue); margin-bottom: 15px; }
        .modal-content p { margin-bottom: 20px; }
        .close-btn { color: var(--white); position: absolute; top: 15px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: var(--tiffany-blue); }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Gerenciador de Ativos</h1></header>
        <div class="actions-bar">
            <button id="export-csv-btn" class="btn">Exportar CSV</button>
            <button id="export-system-btn" class="btn">Exportar Sistema (ZIP)</button>
            <label for="import-system-input" class="btn-like-input-label">Importar Sistema (ZIP)</label>
            <input type="file" id="import-system-input" accept=".zip">
        </div>
        <div class="tabs">
            <button id="form-tab-btn" class="tab-button active" data-tab="tab-form">Cadastrar Ativo</button>
            <button class="tab-button" data-tab="tab-list">Lista de Ativos</button>
        </div>

        <div id="tab-form" class="tab-content active">
            <form id="asset-form">
                <h3 class="section-title">Informações do Ativo</h3>
                <div class="form-group"><label for="etiqueta">Etiqueta de Patrimônio</label><input type="text" id="etiqueta" required></div>
                <div class="form-group"><label for="tipoItem">Tipo do Item</label><select id="tipoItem"></select></div>
                <div class="form-group"><label for="marca">Marca</label><input type="text" id="marca"></div>
                <div class="form-group"><label for="modelo">Modelo</label><input type="text" id="modelo"></div>
                <div class="form-group"><label for="nSerie">N. Série</label><input type="text" id="nSerie"></div>
                <div class="form-group" style="grid-column: 1 / -1;"><label>Imagem do Ativo</label><div id="image-preview-container"><div id="image-controls"><button type="button" id="open-camera-btn" class="btn">Capturar Imagem</button><label for="select-file-btn" class="btn-like-input-label">Selecionar Arquivo</label><input type="file" id="select-file-btn" accept="image/*"></div><img id="image-preview" src="" alt="Pré-visualização da Imagem"></div></div>
                <div id="celular-fields" class="conditional-fields"><h3 class="section-title">Detalhes do Celular</h3><div class="form-group"><label for="imei1">IMEI 1</label><input type="text" id="imei1"></div><div class="form-group"><label for="imei2">IMEI 2</label><input type="text" id="imei2"></div><div class="form-group"><label for="numeroTelefone">Número de Telefone Vinculado</label><input type="text" id="numeroTelefone"></div></div>
                <div id="notebook-fields" class="conditional-fields"><h3 class="section-title">Especificações do Notebook</h3><div class="form-group"><label for="processador">Processador</label><select id="processador"></select></div><div class="form-group"><label for="memoriaRam">Memória RAM</label><select id="memoriaRam"></select></div><div class="form-group"><label for="memoriaRom">Memória ROM (Armazenamento)</label><select id="memoriaRom"></select></div><div class="form-group"><label for="placaDeVideo">Placa de Vídeo?</label><select id="placaDeVideo"></select></div></div>
                <h3 class="section-title">Status e Localização</h3>
                <div class="form-group"><label for="statusLocalizacao">Status Localização</label><select id="statusLocalizacao"></select></div><div class="form-group"><label for="usuario">Usuário</label><input type="text" id="usuario"></div><div class="form-group"><label for="empresa">Empresa</label><select id="empresa"></select></div><div class="form-group"><label for="dpto">Departamento</label><select id="dpto"></select></div><div class="form-group"><label for="unidade">Unidade</label><select id="unidade"></select></div><div class="form-group"><label for="localizacao">Localização Física</label><input type="text" id="localizacao"></div>
                <h3 class="section-title">Condição e Descrição</h3>
                <div class="form-group"><label for="estadoBem">Estado do Bem</label><select id="estadoBem"></select></div><div class="form-group"><label for="descarte">Descarte</label><select id="descarte"></select></div><div class="form-group" style="grid-column: 1 / -1;"><label for="descricao">Descrição</label><textarea id="descricao" rows="3"></textarea></div>
                <h3 class="section-title">Informações Contábeis e de Compra</h3>
                <div class="form-group"><label for="classificacaoContabil">Classificação Contábil</label><select id="classificacaoContabil"></select></div><div class="form-group"><label for="proprietario">Proprietário</label><input type="text" id="proprietario"></div><div class="form-group"><label for="notaFiscal">Nota Fiscal</label><input type="text" id="notaFiscal"></div><div class="form-group"><label for="valor">Valor (R$)</label><input type="number" id="valor" step="0.01"></div><div class="form-group"><label for="dataCompra">Data da Compra</label><input type="date" id="dataCompra"></div>
                <div class="form-actions"><button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display: none;">Cancelar Edição</button><button type="submit" id="submit-btn" class="btn">Salvar Ativo</button></div>
            </form>
        </div>

        <div id="tab-list" class="tab-content">
            <div class="list-controls">
                <div class="search-group">
                    <select id="search-column"></select>
                    <input type="search" id="search-input" class="search-input" placeholder="Pesquisar ativos...">
                </div>
                <div class="dropdown">
                    <button id="toggle-columns-btn" class="btn">Exibir Colunas</button>
                    <div id="columns-dropdown" class="dropdown-content"></div>
                </div>
                <button id="bulk-edit-btn" class="btn">Ação em Massa</button>
                <button id="bulk-delete-btn" class="btn btn-danger">Excluir Selecionados</button>
            </div>

            <div class="table-container">
                <table id="asset-table">
                    <thead id="asset-table-head"></thead>
                    <tbody id="asset-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="bulk-edit-modal" class="modal">
        <div class="modal-content">
            <span id="close-bulk-modal-btn" class="close-btn">&times;</span>
            <h2>Ação em Massa</h2>
            <p>Alterar os campos para <strong id="bulk-edit-count">0</strong> itens selecionados. Deixe um campo em branco para não alterá-lo.</p>
            <form id="bulk-edit-form">
                <div class="form-group"><label for="bulk-tipoItem">Tipo do Item</label><select id="bulk-tipoItem"></select></div>
                <div class="form-group"><label for="bulk-marca">Marca</label><input type="text" id="bulk-marca" placeholder="Não alterar"></div>
                <div class="form-group"><label for="bulk-modelo">Modelo</label><input type="text" id="bulk-modelo" placeholder="Não alterar"></div>
                <div class="form-group"><label for="bulk-statusLocalizacao">Status Localização</label><select id="bulk-statusLocalizacao"></select></div>
                <div class="form-group"><label for="bulk-usuario">Usuário</label><input type="text" id="bulk-usuario" placeholder="Não alterar"></div>
                <div class="form-group"><label for="bulk-empresa">Empresa</label><select id="bulk-empresa"></select></div>
                <div class="form-group"><label for="bulk-dpto">Departamento</label><select id="bulk-dpto"></select></div>
                <div class="form-group"><label for="bulk-unidade">Unidade</label><select id="bulk-unidade"></select></div>
                <div class="form-group"><label for="bulk-localizacao">Localização Física</label><input type="text" id="bulk-localizacao" placeholder="Não alterar"></div>
                <div class="form-group"><label for="bulk-estadoBem">Estado do Bem</label><select id="bulk-estadoBem"></select></div>
                <div class="form-group"><label for="bulk-descarte">Descarte</label><select id="bulk-descarte"></select></div>
                <div class="form-group" style="grid-column: 1 / -1;"><label for="bulk-descricao">Descrição</label><textarea id="bulk-descricao" rows="3" placeholder="Não alterar"></textarea></div>
                <div class="form-group"><label for="bulk-classificacaoContabil">Classificação Contábil</label><select id="bulk-classificacaoContabil"></select></div>
                <div class="form-group"><label for="bulk-proprietario">Proprietário</label><input type="text" id="bulk-proprietario" placeholder="Não alterar"></div>
                <div class="form-group"><label for="bulk-notaFiscal">Nota Fiscal</label><input type="text" id="bulk-notaFiscal" placeholder="Não alterar"></div>
                <div class="form-group"><label for="bulk-valor">Valor (R$)</label><input type="number" id="bulk-valor" step="0.01" placeholder="Não alterar"></div>
                <div class="form-group"><label for="bulk-dataCompra">Data da Compra</label><input type="date" id="bulk-dataCompra"></div>
            </form>
            <div class="form-actions">
                <button type="button" id="save-bulk-edit-btn" class="btn">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div id="camera-modal"><video id="camera-feed" playsinline autoplay></video><div class="modal-buttons"><button id="snap-photo-btn" class="btn">Tirar Foto</button><button id="cancel-camera-btn" class="btn btn-danger">Cancelar</button></div></div>
    <div id="exit-toast">Pressione voltar novamente para sair</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const STORAGE_KEY = 'gerenciadorDeAtivosData';
        const COLUMN_VISIBILITY_KEY = 'gerenciadorDeAtivosColumns';
        const form = document.getElementById('asset-form');
        const tableHead = document.getElementById('asset-table-head');
        const tableBody = document.getElementById('asset-table-body');
        const searchInput = document.getElementById('search-input');
        const searchColumnSelect = document.getElementById('search-column');
        const toggleColumnsBtn = document.getElementById('toggle-columns-btn');
        const columnsDropdown = document.getElementById('columns-dropdown');
        const selectAllCheckbox = document.createElement('input');
        selectAllCheckbox.type = 'checkbox';
        selectAllCheckbox.id = 'select-all-checkbox';
        selectAllCheckbox.title = 'Selecionar Todos';

        let editingIndex = null;
        let currentImageData = { fileName: null, dataUrl: null };
        let cameraStream = null;
        const choicesInstances = {};
        const bulkChoicesInstances = {};
        let lastCheckedCheckbox = null;

        const allColumns = {
            select: { label: '' },
            imageDataUrl: { label: 'Imagem' },
            etiqueta: { label: 'Etiqueta' },
            empresa: { label: 'Empresa' },
            tipoItem: { label: 'Tipo' },
            statusLocalizacao: { label: 'Status Loc.' },
            unidade: { label: 'Unidade' },
            usuario: { label: 'Usuário' },
            localizacao: { label: 'Localização' },
            nSerie: { label: 'N. Série' },
            marca: { label: 'Marca' },
            modelo: { label: 'Modelo' },
            dataCompra: { label: 'Data Compra' },
            valor: { label: 'Valor' },
            actions: { label: 'Ações' }
        };

        const loadAtivos = () => { try { const data = localStorage.getItem(STORAGE_KEY); return data ? JSON.parse(data) : []; } catch (e) { return []; } };
        const saveAtivos = () => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(ativos)); } catch (e) { alert("Não foi possível salvar os dados."); } };
        let ativos = loadAtivos();

        const loadColumnVisibility = () => {
            const saved = localStorage.getItem(COLUMN_VISIBILITY_KEY);
            if (saved) return JSON.parse(saved);
            // Default visibility
            return { select: true, imageDataUrl: true, etiqueta: true, empresa: true, tipoItem: true, statusLocalizacao: true, unidade: true, usuario: true, localizacao: true, nSerie: false, marca: false, modelo: false, dataCompra: false, valor: false, actions: true };
        };
        const saveColumnVisibility = (visibility) => {
            localStorage.setItem(COLUMN_VISIBILITY_KEY, JSON.stringify(visibility));
        };
        let columnVisibility = loadColumnVisibility();

        const options = {
            empresa: ['PPay', 'MNTZZ', 'VG'],
            tipoItem: ["Notebook", "Celular", "Desktop", "Fonte Notebook", "Radio Comunicador", "Monitor", "Apoio de Pé", "Teclado", "Mouse", "Tablet", "Carregador", "Câmera de Segurança", "Headset", "Suporte Papel Higiênico", "Suporte Sabão Líquido", "Suporte Papel Toalha", "Espelho", "Proteção de Ar Condicionado", "Webcam", "Impressora", "Scanner", "Nobreak (UPS)", "Roteador", "Switch", "Servidor", "Projetor", "TV", "Mesa", "Cadeira", "Cadeira de Escritório", "Cadeira de Reunião", "Armário", "Gaveteiro", "Estante", "Sofá", "Poltrona", "Quadro Branco", "Lixeira", "Geladeira", "Micro-ondas", "Bebedouro", "Cafeteira", "Ar Condicionado", "Ventilador", "Extintor de Incêndio", "Outro"],
            statusLocalizacao: ['Em estoque', 'Em uso', 'Em manutenção', 'Para descarte'],
            dpto: ["FACILITIES", "TI", "INFRA", "CS", "JURIDICO", "FINANCEIRO", "MARKETING", "EVENTOS", "ADM", "DIRETORIA"],
            unidade: ['TERRACINHO', 'MATRIZ', 'PO'],
            classificacaoContabil: ["Móveis e Utensílios", "Computadores e Periféricos", "Aparelhos telefônicos", "Bens de pequeno valor", "Máquinas e equipamentos", "Adornos"],
            estadoBem: ['Novo', 'Bom', 'Regular', 'Ruim', 'Sucata'],
            descarte: ['Não', 'Sim'],
            processador: ['i3', 'i5', 'i7', 'Ryzen 3', 'Ryzen 5', 'Ryzen 7'],
            memoriaRam: ['4GB', '8GB', '12GB', '16GB', '32GB'],
            memoriaRom: ['128GB SSD', '256GB SSD', '512GB SSD', '1TB SSD', '500GB HDD', '1TB HDD'],
            placaDeVideo: ['Não', 'Sim']
        };
        const formFields = ['etiqueta', 'statusLocalizacao', 'tipoItem', 'marca', 'modelo', 'nSerie', 'imei1', 'imei2', 'descricao', 'classificacaoContabil', 'localizacao', 'usuario', 'empresa', 'dpto', 'unidade', 'notaFiscal', 'valor', 'dataCompra', 'estadoBem', 'descarte', 'proprietario', 'numeroTelefone', 'processador', 'memoriaRam', 'memoriaRom', 'placaDeVideo'];
        const bulkEditFields = ['tipoItem', 'marca', 'modelo', 'statusLocalizacao', 'usuario', 'empresa', 'dpto', 'unidade', 'localizacao', 'estadoBem', 'descarte', 'descricao', 'classificacaoContabil', 'proprietario', 'notaFiscal', 'valor', 'dataCompra'];

        function setupColumnControls() {
            columnsDropdown.innerHTML = '';
            Object.keys(allColumns).forEach(key => {
                if (key === 'select' || key === 'actions') return;
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.key = key;
                checkbox.checked = columnVisibility[key];
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(allColumns[key].label));
                columnsDropdown.appendChild(label);
            });
        }

        function setupSearch() {
            const searchableColumns = { all: 'Qualquer Coluna', ...Object.fromEntries(Object.entries(allColumns).filter(([k,v]) => k !== 'select' && k !== 'actions' && k !== 'imageDataUrl').map(([k,v]) => [k, v.label])) };
            searchColumnSelect.innerHTML = Object.entries(searchableColumns).map(([key, label]) => `<option value="${key}">${label}</option>`).join('');
        }

        function renderTable() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const searchColumn = searchColumnSelect.value;

            tableHead.innerHTML = '';
            const headerRow = document.createElement('tr');
            Object.keys(allColumns).forEach(key => {
                const th = document.createElement('th');
                th.dataset.key = key;
                if (key === 'select') {
                    th.appendChild(selectAllCheckbox);
                } else {
                    th.textContent = allColumns[key].label;
                }
                if (!columnVisibility[key]) th.classList.add('hidden');
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            tableBody.innerHTML = '';
            const filteredAtivos = ativos.filter(ativo => {
                if (!searchTerm) return true;
                if (searchColumn === 'all') {
                    return Object.keys(ativo).some(key => 
                        ativo[key] && ativo[key].toString().toLowerCase().includes(searchTerm)
                    );
                } else {
                    return ativo[searchColumn] && ativo[searchColumn].toString().toLowerCase().includes(searchTerm);
                }
            });

            if (filteredAtivos.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="${Object.keys(allColumns).length}" style="text-align:center; padding: 20px;">Nenhum ativo encontrado.</td></tr>`;
            } else {
                filteredAtivos.forEach(ativo => {
                    const originalIndex = ativos.indexOf(ativo);
                    const row = document.createElement('tr');
                    row.dataset.index = originalIndex;

                    Object.keys(allColumns).forEach(key => {
                        const td = document.createElement('td');
                        td.dataset.key = key;
                        if (!columnVisibility[key]) td.classList.add('hidden');

                        switch (key) {
                            case 'select':
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.className = 'row-checkbox';
                                checkbox.dataset.index = originalIndex;
                                td.appendChild(checkbox);
                                break;
                            case 'imageDataUrl':
                                td.innerHTML = ativo.imageDataUrl ? `<a href="${ativo.imageDataUrl}" target="_blank"><img src="${ativo.imageDataUrl}" class="asset-image-thumbnail" alt="${ativo.imageFilename || ''}"></a>` : 'N/A';
                                break;
                            case 'actions':
                                td.innerHTML = `<button class="btn btn-edit edit-btn" data-index="${originalIndex}">Editar</button> <button class="btn btn-danger remove-btn" data-index="${originalIndex}">Remover</button>`;
                                break;
                            default:
                                td.textContent = ativo[key] || '';
                                break;
                        }
                        row.appendChild(td);
                    });
                    tableBody.appendChild(row);
                });
            }
            updateBulkActionUI();
            lastCheckedCheckbox = null;
        };

        function updateColumnVisibility() {
            Object.keys(allColumns).forEach(key => {
                const visible = columnVisibility[key];
                document.querySelectorAll(`#asset-table [data-key='${key}']`).forEach(el => {
                    el.classList.toggle('hidden', !visible);
                });
            });
        }

        // Funções de Ação em Massa e outras (sem alterações significativas)
        function updateBulkActionUI() { const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked'); const anySelected = selectedCheckboxes.length > 0; const bulkDeleteBtn = document.getElementById('bulk-delete-btn'); const bulkEditBtn = document.getElementById('bulk-edit-btn'); bulkDeleteBtn.style.display = anySelected ? 'inline-block' : 'none'; bulkEditBtn.style.display = anySelected ? 'inline-block' : 'none'; if (anySelected) { bulkDeleteBtn.textContent = `Excluir ${selectedCheckboxes.length}`; bulkEditBtn.textContent = `Ação em Massa (${selectedCheckboxes.length})`; } const allVisibleCheckboxes = document.querySelectorAll('#asset-table-body .row-checkbox'); if (allVisibleCheckboxes.length > 0 && selectedCheckboxes.length === allVisibleCheckboxes.length) { selectAllCheckbox.checked = true; selectAllCheckbox.indeterminate = false; } else if (anySelected) { selectAllCheckbox.checked = false; selectAllCheckbox.indeterminate = true; } else { selectAllCheckbox.checked = false; selectAllCheckbox.indeterminate = false; } }
        function handleBulkDelete() { const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked'); if (selectedCheckboxes.length === 0) return; if (confirm(`Tem certeza que deseja excluir os ${selectedCheckboxes.length} ativos selecionados?`)) { const indicesToDelete = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index, 10)); ativos = ativos.filter((_, index) => !indicesToDelete.includes(index)); saveAtivos(); renderTable(); } }
        function openBulkEditModal() { const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked'); if (selectedCheckboxes.length === 0) return; document.getElementById('bulk-edit-count').textContent = selectedCheckboxes.length; document.getElementById('bulk-edit-modal').style.display = 'block'; }
        function closeBulkEditModal() { document.getElementById('bulk-edit-modal').style.display = 'none'; document.getElementById('bulk-edit-form').reset(); for (const id in bulkChoicesInstances) { bulkChoicesInstances[id].setChoiceByValue(''); } }
        function handleBulkEditSave() { const selectedIndices = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => parseInt(cb.dataset.index, 10)); if (selectedIndices.length === 0) return; let changesMade = false; selectedIndices.forEach(index => { const ativo = ativos[index]; bulkEditFields.forEach(field => { const bulkElement = document.getElementById(`bulk-${field}`); if (!bulkElement) return; let value; if (bulkChoicesInstances[`bulk-${field}`]) { value = bulkChoicesInstances[`bulk-${field}`].getValue(true); } else { value = bulkElement.value; } if (value !== null && value !== undefined && value !== '') { if (ativo[field] !== value) { ativo[field] = value; changesMade = true; } } }); }); if (changesMade) { saveAtivos(); renderTable(); alert(`${selectedIndices.length} ativos foram atualizados!`); } else { alert("Nenhuma alteração foi feita."); } closeBulkEditModal(); }
        function initializeChoices(prefix = '', instanceObject = choicesInstances) { for (const id in options) { const selectElement = document.getElementById(`${prefix}${id}`); if (selectElement) { instanceObject[`${prefix}${id}`] = new Choices(selectElement, { choices: options[id].map(val => ({ value: val, label: val })), removeItemButton: true, searchResultLimit: 15, itemSelectText: 'Pressione para selecionar', placeholder: true, placeholderValue: 'Selecione uma opção' }); } } const tipoItemElement = document.getElementById('tipoItem'); if (tipoItemElement) { tipoItemElement.addEventListener('change', toggleConditionalFields); } }
        function toggleConditionalFields() { const tipo = choicesInstances['tipoItem'] ? choicesInstances['tipoItem'].getValue(true) : ''; document.getElementById('notebook-fields').classList.toggle('visible', tipo === 'Notebook'); document.getElementById('celular-fields').classList.toggle('visible', tipo === 'Celular'); }
        function getFormData() { const data = {}; formFields.forEach(id => { const element = document.getElementById(id); if (element) data[id] = choicesInstances[id] ? choicesInstances[id].getValue(true) : element.value; }); data.imageFilename = currentImageData.fileName; data.imageDataUrl = currentImageData.dataUrl; return data; };
        function setFormData(ativo) { formFields.forEach(id => { const element = document.getElementById(id); if (choicesInstances[id]) { choicesInstances[id].setChoices(options[id].map(val => ({ value: val, label: val })), 'value', 'label', true); if (ativo[id]) { choicesInstances[id].setChoiceByValue(String(ativo[id])); } else { choicesInstances[id].setChoiceByValue(''); } } else if (element) { element.value = ativo[id] || ''; } }); };
        function handleFormSubmit(e) { e.preventDefault(); const ativoData = getFormData(); if (editingIndex !== null) { ativos[editingIndex] = ativoData; } else { ativos.push(ativoData); } saveAtivos(); resetFormMode(); renderTable(); alert(editingIndex !== null ? 'Ativo atualizado!' : 'Ativo cadastrado!'); };
        function startEditing(index) { editingIndex = index; const ativo = ativos[index]; setFormData(ativo); currentImageData = { fileName: ativo.imageFilename, dataUrl: ativo.imageDataUrl }; const imagePreview = document.getElementById('image-preview'); if (ativo.imageDataUrl) { imagePreview.src = ativo.imageDataUrl; imagePreview.style.display = 'block'; } else { imagePreview.style.display = 'none'; } document.getElementById('submit-btn').textContent = 'Atualizar Ativo'; document.getElementById('cancel-edit-btn').style.display = 'inline-block'; document.getElementById('form-tab-btn').click(); window.scrollTo({ top: 0, behavior: 'smooth' }); toggleConditionalFields(); };
        function resetFormMode() { editingIndex = null; document.getElementById('asset-form').reset(); for (const id in choicesInstances) { choicesInstances[id].setChoiceByValue(''); } const imagePreview = document.getElementById('image-preview'); imagePreview.style.display = 'none'; imagePreview.src = ''; currentImageData = { fileName: null, dataUrl: null }; document.getElementById('submit-btn').textContent = 'Salvar Ativo'; document.getElementById('cancel-edit-btn').style.display = 'none'; toggleConditionalFields(); };

        // --- EVENT LISTENERS ---
        document.getElementById('asset-form').addEventListener('submit', handleFormSubmit);
        document.getElementById('cancel-edit-btn').addEventListener('click', resetFormMode);
        document.querySelectorAll('.tab-button').forEach(tab => tab.addEventListener('click', (e) => { document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); e.currentTarget.classList.add('active'); document.getElementById(e.currentTarget.dataset.tab).classList.add('active'); if(e.currentTarget.dataset.tab === 'tab-list') renderTable(); }));
        tableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) { handleBulkDelete(); }
            if (e.target.classList.contains('edit-btn')) { startEditing(parseInt(e.target.dataset.index, 10)); }
            if (e.target.classList.contains('row-checkbox')) {
                if (e.shiftKey && lastCheckedCheckbox) {
                    const checkboxes = Array.from(tableBody.querySelectorAll('.row-checkbox'));
                    const start = checkboxes.indexOf(lastCheckedCheckbox);
                    const end = checkboxes.indexOf(e.target);
                    const range = (start < end) ? checkboxes.slice(start, end + 1) : checkboxes.slice(end, start + 1);
                    range.forEach(checkbox => checkbox.checked = lastCheckedCheckbox.checked);
                }
                lastCheckedCheckbox = e.target;
                updateBulkActionUI();
            }
        });
        searchInput.addEventListener('input', renderTable);
        searchColumnSelect.addEventListener('change', renderTable);
        selectAllCheckbox.addEventListener('click', (e) => { document.querySelectorAll('#asset-table-body .row-checkbox').forEach(checkbox => { checkbox.checked = e.target.checked; }); updateBulkActionUI(); });
        document.getElementById('bulk-delete-btn').addEventListener('click', handleBulkDelete);
        document.getElementById('bulk-edit-btn').addEventListener('click', openBulkEditModal);
        document.getElementById('close-bulk-modal-btn').addEventListener('click', closeBulkEditModal);
        document.getElementById('save-bulk-edit-btn').addEventListener('click', handleBulkEditSave);
        toggleColumnsBtn.addEventListener('click', () => columnsDropdown.classList.toggle('show'));
        columnsDropdown.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const key = e.target.dataset.key;
                columnVisibility[key] = e.target.checked;
                saveColumnVisibility(columnVisibility);
                updateColumnVisibility();
            }
        });
        window.addEventListener('click', (e) => { if (!e.target.matches('#toggle-columns-btn')) { if (columnsDropdown.classList.contains('show')) { columnsDropdown.classList.remove('show'); } } if (e.target == document.getElementById('bulk-edit-modal')) { closeBulkEditModal(); } });

        // --- INICIALIZAÇÃO ---
        initializeChoices('', choicesInstances);
        initializeChoices('bulk-', bulkChoicesInstances);
        setupColumnControls();
        setupSearch();
        renderTable();
    });
    </script>
</body>
</html>
