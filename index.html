<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gerenciador de Ativos</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#005C73">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    
    <style>
        :root {
            --tiffany-blue: #96D1D3; --midnight-green: #003e4d; --teal: #01848C; --teal-bg: #005C73;
            --white: #f0f8ff; --light-gray: #cddce7; --danger: #e74c3c; --warning: #f39c12;
            --shadow: rgba(0, 0, 0, 0.4);
            --bs-success-rgb: 40, 167, 69; --bs-warning-rgb: 243, 156, 18;
            --bs-secondary-rgb: 108, 117, 125; --bs-danger-rgb: 220, 53, 69;
        }
        * { transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.2s ease; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--midnight-green); color: var(--light-gray); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .main-container { background-color: var(--teal-bg); backdrop-filter: blur(10px); border: 1px solid var(--teal); }
        .header-title { color: var(--tiffany-blue); text-shadow: 1px 1px 4px var(--shadow); }
        .btn { font-weight: 500; }
        .btn-primary { background-color: var(--teal); border-color: var(--teal); color: var(--white); }
        .btn-primary:hover, .btn-primary:focus { background-color: var(--tiffany-blue); border-color: var(--tiffany-blue); color: var(--midnight-green); }
        .btn-outline-primary { border-color: var(--teal); color: var(--tiffany-blue); }
        .btn-outline-primary:hover, .btn-outline-primary:focus { background-color: var(--teal); color: var(--white); }
        .btn-danger { background-color: var(--danger); border-color: var(--danger); color: var(--white) !important; }
        .btn-warning { background-color: var(--warning); border-color: var(--warning); color: var(--white) !important; }
        .nav-tabs .nav-link { background-color: transparent; border: none; color: var(--tiffany-blue); border-bottom: 3px solid transparent; }
        .nav-tabs .nav-link.active { background-color: rgba(0,0,0,0.2); border-bottom-color: var(--tiffany-blue); color: var(--white); }
        .form-control, .form-select { background-color: rgba(0, 0, 0, 0.25); border-color: var(--teal); color: var(--white); }
        .form-control:focus, .form-select:focus { background-color: rgba(0, 0, 0, 0.35); border-color: var(--tiffany-blue); color: var(--white); box-shadow: 0 0 0 0.25rem rgba(150, 209, 211, 0.25); }
        .form-label { color: var(--tiffany-blue); font-weight: 500; }
        .section-title { color: var(--tiffany-blue); border-bottom: 1px solid var(--teal); }
        .form-check-input { background-color: rgba(0,0,0,0.3); border-color: var(--teal); }
        .form-check-input:checked { background-color: var(--teal); border-color: var(--tiffany-blue); }
        .choices__inner { background-color: rgba(0, 0, 0, 0.25) !important; border-color: var(--teal) !important; color: var(--white) !important; border-radius: 0.375rem; }
        .is-open .choices__inner { border-color: var(--tiffany-blue) !important; }
        .choices__list--dropdown { background-color: var(--midnight-green) !important; border-color: var(--tiffany-blue) !important; }
        .choices__list--dropdown .choices__item--choice { color: var(--white) !important; }
        .choices__item--choice.is-highlighted { background-color: var(--tiffany-blue) !important; color: var(--midnight-green) !important; }
        .choices__list--multiple .choices__item { background-color: var(--teal) !important; border-color: var(--tiffany-blue) !important; }
        @keyframes card-fade-in { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .asset-card { background-color: rgba(0, 0, 0, 0.2); border: 1px solid var(--teal); opacity: 0; transform: translateY(15px); }
        .asset-card.visible { animation: card-fade-in 0.5s ease-out forwards; }
        .asset-card:hover { transform: scale(1.02); box-shadow: 0 6px 20px var(--shadow); border-color: var(--tiffany-blue); z-index: 10; position: relative; }
        .asset-card-title { color: var(--white); font-weight: 600; }
        .asset-card-subtitle { color: var(--tiffany-blue); font-size: 0.9rem; }
        .asset-card-details .detail-item { font-size: 0.85rem; color: var(--light-gray); }
        .asset-card-details .detail-item .bi { color: var(--tiffany-blue); }
        .editable-image-container { position: relative; cursor: pointer; display: block; width: 80px; height: 80px; flex-shrink: 0; }
        .asset-image { width: 100%; height: 100%; object-fit: cover; }
        .editable-image-container::after { content: '\f232'; font-family: 'bootstrap-icons'; position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.6); color: white; font-size: 2rem; opacity: 0; border-radius: 0.375rem; transition: opacity 0.2s ease; }
        .editable-image-container:hover::after { opacity: 1; }
        .status-badge { font-size: 0.75rem; font-weight: 600; padding: 0.3em 0.6em; border-radius: 0.25rem; color: var(--white) !important; }
        .status-em-uso { background-color: rgba(var(--bs-success-rgb), 0.8); }
        .status-em-manutencao { background-color: rgba(var(--bs-warning-rgb), 0.8); }
        .status-em-estoque { background-color: rgba(var(--bs-secondary-rgb), 0.8); }
        .status-para-descarte, .status-defeito { background-color: rgba(var(--bs-danger-rgb), 0.8); }
        #btn-back-to-top { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background-color: var(--teal); color: var(--white); border: none; box-shadow: 0 2px 10px var(--shadow); font-size: 1.5rem; opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 1050; }
        #btn-back-to-top:hover { background-color: var(--tiffany-blue); color: var(--midnight-green); transform: scale(1.1); }
        #btn-back-to-top.show { opacity: 1; visibility: visible; }
        #floating-actions-bar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(0, 40, 50, 0.9); backdrop-filter: blur(5px); border-top: 1px solid var(--teal); box-shadow: 0 -2px 10px rgba(0,0,0,0.3); z-index: 1040; transform: translateY(100%); transition: transform 0.3s ease-in-out; visibility: hidden; }
        #floating-actions-bar.show { transform: translateY(0); visibility: visible; }
        .accordion-button { background-color: rgba(0,0,0,0.2); color: var(--tiffany-blue); font-weight: 500; }
        .accordion-button:not(.collapsed) { background-color: rgba(0,0,0,0.3); color: var(--white); }
        .accordion-button:focus { box-shadow: 0 0 0 0.25rem rgba(150, 209, 211, 0.25); }
        .accordion-button::after { filter: brightness(0) invert(1); }
        .accordion-item { background-color: transparent; border-color: var(--teal); }
        .accordion-body { background-color: rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="container-xl my-3 my-md-4">
        <main class="main-container rounded-4 shadow-lg p-3 p-md-4">
            <header class="text-center pb-3 mb-4 border-bottom border-secondary-subtle">
                <div class="d-flex flex-wrap justify-content-center align-items-center">
                    <h1 class="fw-bold header-title flex-grow-1">Gerenciador de Ativos</h1>
                    <a href="dashboard.html" class="btn btn-outline-primary ms-auto"><i class="bi bi-bar-chart-line-fill me-2"></i>Dashboard</a>
                </div>
            </header>

            <div class="d-flex flex-wrap justify-content-center gap-2 mb-4">
                <button id="export-csv-btn" class="btn btn-primary"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar CSV</button>
                <label for="import-csv-input" class="btn btn-outline-primary"><i class="bi bi-plus-circle me-2"></i>Importar CSV</label>
                <input type="file" id="import-csv-input" class="d-none" accept=".csv">
                <button id="export-system-btn" class="btn btn-primary"><i class="bi bi-archive me-2"></i>Exportar Sistema</button>
                <label for="import-system-input" class="btn btn-outline-primary"><i class="bi bi-upload me-2"></i>Importar Sistema</label>
                <input type="file" id="import-system-input" class="d-none" accept=".zip">
            </div>
            
            <ul class="nav nav-tabs nav-fill mb-3" id="mainTab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" id="form-tab-btn" data-bs-toggle="tab" data-bs-target="#tab-form-pane" type="button" role="tab">Cadastrar / Editar</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="list-tab-btn" data-bs-toggle="tab" data-bs-target="#tab-list-pane" type="button" role="tab">Lista de Ativos</button></li>
            </ul>

            <div class="tab-content" id="mainTabContent">
                <div class="tab-pane fade show active" id="tab-form-pane" role="tabpanel" tabindex="0">
                    <form id="asset-form" class="mt-4"></form>
                </div>

                <div class="tab-pane fade" id="tab-list-pane" role="tabpanel" tabindex="0">
                    
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="quick-search-input" class="form-control" placeholder="Pesquisar em todos os campos...">
                    </div>
                    
                    <div id="bulk-actions-wrapper" class="mb-3">
                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="select-all-checkbox">
                                <label class="form-check-label" for="select-all-checkbox">Selecionar Todos Visíveis</label>
                            </div>
                            <div id="bulk-actions-container" class="d-flex gap-2">
                                <button id="bulk-edit-btn" class="btn btn-sm btn-warning" style="display: none;"><i class="bi bi-pencil-square me-1"></i>Ação em Massa</button>
                                <button id="bulk-delete-btn" class="btn btn-sm btn-danger" style="display: none;"><i class="bi bi-trash me-1"></i>Excluir</button>
                            </div>
                        </div>
                    </div>

                    <div class="accordion mb-3" id="options-accordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-filters">
                                    <i class="bi bi-tools me-2"></i> Filtros Avançados e Visualização
                                </button>
                            </h2>
                            <div id="collapse-filters" class="accordion-collapse collapse" data-bs-parent="#options-accordion">
                                <div class="accordion-body">
                                    <div class="row g-3">
                                        <div class="col-lg-8">
                                            <strong>Filtros por Campo Específico:</strong>
                                            <div id="filter-container" class="d-flex flex-column gap-2 mt-2"></div>
                                            <button id="add-filter-btn" class="btn btn-sm btn-primary mt-2"><i class="bi bi-plus-lg"></i> Adicionar Filtro</button>
                                        </div>
                                        <div class="col-lg-4">
                                            <strong>Exibir Informações nos Cards:</strong>
                                            <div id="info-toggle-dropdown" class="mt-2 vh-25 overflow-auto p-2 rounded" style="background-color: rgba(0,0,0,0.2);"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="asset-list-container" class="d-grid gap-3"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAIS E ELEMENTOS FLUTUANTES -->
    <div class="modal fade" id="bulk-edit-modal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edição em Massa</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"></div></div></div></div>
    <div class="modal fade" id="camera-modal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Capturar Imagem</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><video id="camera-stream" autoplay playsinline class="w-100"></video></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="capture-image-btn"><i class="bi bi-camera me-2"></i>Capturar</button></div></div></div></div>
    <div class="modal fade" id="image-edit-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Alterar Imagem do Ativo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p>Escolha como deseja alterar a imagem:</p><div class="d-grid gap-2"><label for="quick-image-upload" class="btn btn-primary"><i class="bi bi-image me-2"></i>Selecionar Arquivo</label><input type="file" id="quick-image-upload" class="d-none" accept="image/*"><button id="quick-image-capture" class="btn btn-outline-primary"><i class="bi bi-camera me-2"></i>Capturar com a Câmera</button></div></div></div></div></div>
    
    <div id="floating-actions-bar" class="p-2">
        <div class="container d-flex justify-content-end align-items-center gap-2">
            <span id="floating-selection-count" class="text-white me-2"></span>
            <button id="floating-bulk-edit-btn" class="btn btn-sm btn-warning"><i class="bi bi-pencil-square me-1"></i>Ação</button>
            <button id="floating-bulk-delete-btn" class="btn btn-sm btn-danger"><i class="bi bi-trash me-1"></i>Excluir</button>
        </div>
    </div>
    
    <button id="btn-back-to-top"><i class="bi bi-arrow-up"></i></button>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const STORAGE_KEY = 'gerenciadorDeAtivosData';
        const VISIBILITY_KEY = 'gerenciadorDeAtivosCardVisibility';
        const form = document.getElementById('asset-form');
        const assetListContainer = document.getElementById('asset-list-container');
        const addFilterBtn = document.getElementById('add-filter-btn');
        const filterContainer = document.getElementById('filter-container');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const backToTopButton = document.getElementById('btn-back-to-top');
        const infoToggleDropdown = document.getElementById('info-toggle-dropdown');
        const quickSearchInput = document.getElementById('quick-search-input');
        const bulkActionsWrapper = document.getElementById('bulk-actions-wrapper');
        const floatingActionsBar = document.getElementById('floating-actions-bar');
        const bulkEditModal = new bootstrap.Modal('#bulk-edit-modal');
        const cameraBootstrapModal = new bootstrap.Modal('#camera-modal');
        const imageEditModal = new bootstrap.Modal('#image-edit-modal');
        const quickImageUploadInput = document.getElementById('quick-image-upload');
        const quickImageCaptureBtn = document.getElementById('quick-image-capture');
        let editingIndex = null;
        let editingImageIndex = null;
        let currentImageData = { fileName: null, dataUrl: null };
        let cameraStream = null;
        const choicesInstances = {};
        const bulkChoicesInstances = {};
        const filterChoicesInstances = {};
        let lastCheckedCheckbox = null;
        let activeFilters = [];
        let quickSearchTerm = '';
        const fieldLabels = { etiqueta: 'Etiqueta', tipoItem: 'Tipo', marca: 'Marca', modelo: 'Modelo', nSerie: 'N. Série', imei1: 'IMEI 1', imei2: 'IMEI 2', descricao: 'Descrição', classificacaoContabil: 'Class. Contábil', localizacao: 'Localização', usuario: 'Usuário', empresa: 'Empresa', dpto: 'Departamento', unidade: 'Unidade', notaFiscal: 'Nota Fiscal', valor: 'Valor (R$)', dataCompra: 'Data da Compra', estadoBem: 'Estado do Bem', descarte: 'Descarte', proprietario: 'Proprietário', numeroTelefone: 'Nº Telefone', processador: 'Processador', memoriaRam: 'RAM', memoriaRom: 'Armazenamento', placaDeVideo: 'Placa de Vídeo', statusLocalizacao: 'Status' };
        const loadCardVisibility = () => { const defaultVisibility = { etiqueta: true, tipoItem: true, usuario: true, localizacao: true, marca: true, modelo: true, estadoBem: true }; try { const stored = localStorage.getItem(VISIBILITY_KEY); return stored ? { ...defaultVisibility, ...JSON.parse(stored) } : defaultVisibility; } catch (e) { return defaultVisibility; } };
        const saveCardVisibility = () => { try { localStorage.setItem(VISIBILITY_KEY, JSON.stringify(cardVisibility)); } catch (e) { console.error("Falha ao salvar visibilidade", e); } };
        let cardVisibility = loadCardVisibility();
        const filterableColumns = { etiqueta: { label: 'Etiqueta' }, tipoItem: { label: 'Tipo' }, marca: { label: 'Marca' }, modelo: { label: 'Modelo' }, nSerie: { label: 'N. Série' }, estadoBem: {label: 'Estado'}, statusLocalizacao: { label: 'Status' }, usuario: { label: 'Usuário' }, empresa: { label: 'Empresa' }, dpto: { label: 'Dpto' }, unidade: { label: 'Unidade' }, localizacao: { label: 'Localização' } };
        const options = { empresa: ['PPay', 'MNTZZ', 'VG'], tipoItem: ["Notebook", "Celular", "Desktop", "Fonte Notebook", "Radio Comunicador", "Monitor", "Apoio de Pé", "Teclado", "Mouse", "HUB USB", "Roteador", "Microondas", "Mesa", "Cadeira", "Armario", "Ar Condicionado", "Suporte de Ar Condicionado", "Suporte Papel Higiênico", "Suporte Sabonete Líquido", "Geladeira", "Lixeira", "Extintor", "Sofá", "Mesa Ping-Pong", "Poltrona", "Suporte Papel Toalha", "Espelho", "Quadro Branco", "Estante", "Filtro de Água", "Frigobar", "Prateleira", "Cortina", "Cafeteira",  "Tablet", "Carregador", "Câmera de Segurança", "Headset", "Outro"], statusLocalizacao: ['Em estoque', 'Em uso', 'Em manutenção', 'Defeito'], dpto: ["FACILITIES", "TI", "INFRA", "CS", "JURIDICO", "FINANCEIRO", "MARKETING", "EVENTOS", "ADM", "DIRETORIA"], unidade: ['TERRACINHO', 'MATRIZ', 'PO'], classificacaoContabil: ["Móveis e Utensílios", "Computadores e Periféricos", "Aparelhos telefônicos", "Bens de pequeno valor", "Máquinas e equipamentos", "Adornos"], estadoBem: ['Novo', 'Bom', 'Regular', 'Ruim', 'Sucata'], descarte: ['Não', 'Sim'], processador: ['i3', 'i5', 'i7', 'Ryzen 3', 'Ryzen 5', 'Ryzen 7'], memoriaRam: ['4GB', '8GB', '12GB', '16GB', '32GB'], memoriaRom: ['128GB SSD', '256GB SSD', '512GB SSD', '1TB SSD', '500GB HDD', '1TB HDD'], placaDeVideo: ['Não', 'Sim'] };
        const formFields = ['etiqueta', 'statusLocalizacao', 'tipoItem', 'marca', 'modelo', 'nSerie', 'imei1', 'imei2', 'descricao', 'classificacaoContabil', 'localizacao', 'usuario', 'empresa', 'dpto', 'unidade', 'notaFiscal', 'valor', 'dataCompra', 'estadoBem', 'descarte', 'proprietario', 'numeroTelefone', 'processador', 'memoriaRam', 'memoriaRom', 'placaDeVideo'];
        const bulkEditFields = ['tipoItem', 'marca', 'modelo', 'statusLocalizacao', 'usuario', 'empresa', 'dpto', 'unidade', 'localizacao', 'estadoBem', 'descarte', 'descricao', 'classificacaoContabil', 'proprietario', 'notaFiscal', 'valor', 'dataCompra'];
        const loadAtivos = () => { try { const data = localStorage.getItem(STORAGE_KEY); return data ? JSON.parse(data) : []; } catch (e) { return []; } };
        const saveAtivos = () => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(ativos)); } catch (e) { alert("Não foi possível salvar os dados."); } };
        let ativos = loadAtivos();
        (() => { let migrationNeeded = false; ativos.forEach(ativo => { if (!ativo.assetId) { ativo.assetId = Date.now().toString(36) + Math.random().toString(36).substring(2); migrationNeeded = true; } }); if (migrationNeeded) { console.log('Migração de dados concluída.'); saveAtivos(); } })();

        const createFieldHtml = (id, label, type = 'text') => { const fullLabel = fieldLabels[id] || label; if (type === 'select') { return `<div class="mb-3"><label for="${id}" class="form-label">${fullLabel}</label><select id="${id}"></select></div>`; } else if (type === 'textarea') { return `<div class="mb-3"><label for="${id}" class="form-label">${fullLabel}</label><textarea id="${id}" rows="3" class="form-control"></textarea></div>`; } else { return `<div class="mb-3"><label for="${id}" class="form-label">${fullLabel}</label><input type="${type}" id="${id}" class="form-control" ${type === 'number' ? 'step="0.01"' : ''}></div>`; } };
        function renderMainForm() { form.innerHTML = `<div class="row"><div class="col-12"><h5 class="section-title">Informações do Ativo</h5></div><div class="col-md-6 col-lg-4">${createFieldHtml('etiqueta')}</div><div class="col-md-6 col-lg-4">${createFieldHtml('tipoItem', null, 'select')}</div><div class="col-md-6 col-lg-4">${createFieldHtml('marca')}</div><div class="col-md-6 col-lg-4">${createFieldHtml('modelo')}</div><div class="col-md-6 col-lg-4">${createFieldHtml('nSerie')}</div><div class="col-12 mb-3"><label class="form-label">Imagem do Ativo</label><div class="d-flex align-items-start gap-3"><img id="image-preview" alt="Pré-visualização" style="max-width: 120px; max-height: 120px; border-radius: 0.375rem; border: 1px dashed var(--teal); display: none;"><div class="d-flex flex-wrap gap-2"><button type="button" id="open-camera-btn" class="btn btn-outline-primary"><i class="bi bi-camera me-1"></i>Capturar</button><label for="select-file-btn" class="btn btn-outline-primary"><i class="bi bi-image me-1"></i>Selecionar</label><input type="file" id="select-file-btn" class="d-none" accept="image/*"></div></div></div></div><div id="celular-fields" class="row gx-3" style="display: none;"><div class="col-12"><h5 class="section-title mt-3">Detalhes do Celular</h5></div><div class="col-md-4">${createFieldHtml('imei1')}</div><div class="col-md-4">${createFieldHtml('imei2')}</div><div class="col-md-4">${createFieldHtml('numeroTelefone')}</div></div><div id="notebook-fields" class="row gx-3" style="display: none;"><div class="col-12"><h5 class="section-title mt-3">Especificações</h5></div><div class="col-md-6 col-lg-3">${createFieldHtml('processador', null, 'select')}</div><div class="col-md-6 col-lg-3">${createFieldHtml('memoriaRam', null, 'select')}</div><div class="col-md-6 col-lg-3">${createFieldHtml('memoriaRom', null, 'select')}</div><div class="col-md-6 col-lg-3">${createFieldHtml('placaDeVideo', null, 'select')}</div></div><div class="row mt-3"><div class="col-12"><h5 class="section-title">Status e Localização</h5></div><div class="col-md-6 col-lg-3">${createFieldHtml('statusLocalizacao', null, 'select')}</div><div class="col-md-6 col-lg-3">${createFieldHtml('usuario')}</div><div class="col-md-6 col-lg-2">${createFieldHtml('empresa', null, 'select')}</div><div class="col-md-6 col-lg-2">${createFieldHtml('dpto', null, 'select')}</div><div class="col-md-6 col-lg-2">${createFieldHtml('unidade', null, 'select')}</div><div class="col-12">${createFieldHtml('localizacao')}</div></div><div class="row mt-3"><div class="col-12"><h5 class="section-title">Condição e Descrição</h5></div><div class="col-md-6">${createFieldHtml('estadoBem', null, 'select')}</div><div class="col-md-6">${createFieldHtml('descarte', null, 'select')}</div><div class="col-12">${createFieldHtml('descricao', null, 'textarea')}</div></div><div class="row mt-3"><div class="col-12"><h5 class="section-title">Informações de Compra</h5></div><div class="col-md-6 col-lg-4">${createFieldHtml('classificacaoContabil', null, 'select')}</div><div class="col-md-6 col-lg-4">${createFieldHtml('proprietario')}</div><div class="col-md-6 col-lg-4">${createFieldHtml('notaFiscal')}</div><div class="col-md-6 col-lg-6">${createFieldHtml('valor', null, 'number')}</div><div class="col-md-6 col-lg-6">${createFieldHtml('dataCompra', null, 'date')}</div></div><div class="d-flex justify-content-end gap-2 mt-4"><button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display: none;">Cancelar</button><button type="submit" id="submit-btn" class="btn btn-primary">Salvar Ativo</button></div>`; }
        function renderBulkEditForm() { const bulkEditModalBody = document.querySelector('#bulk-edit-modal .modal-body'); let formHtml = `<form id="bulk-edit-form" class="container-fluid"><p>Preencha os campos para alterar nos <span id="bulk-edit-count" class="fw-bold"></span> itens selecionados.</p><div class="row gx-3">`; bulkEditFields.forEach(field => { const label = fieldLabels[field] || field; if (options[field]) { formHtml += `<div class="col-md-6 col-lg-4 mb-3"><label for="bulk-${field}" class="form-label">${label}</label><select id="bulk-${field}"></select></div>`; } else { const inputType = (field === 'valor') ? 'number' : (field === 'dataCompra') ? 'date' : 'text'; formHtml += `<div class="col-md-6 col-lg-4 mb-3"><label for="bulk-${field}" class="form-label">${label}</label><input type="${inputType}" id="bulk-${field}" class="form-control" ${inputType === 'number' ? 'step="0.01"' : ''}></div>`; } }); formHtml += `</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" id="save-bulk-edit-btn" class="btn btn-primary">Salvar Alterações</button></div></form>`; bulkEditModalBody.innerHTML = formHtml; }
        function renderFilterControls() { filterContainer.innerHTML = ''; for (const key in filterChoicesInstances) { if (filterChoicesInstances[key]) { filterChoicesInstances[key].destroy(); delete filterChoicesInstances[key]; } } activeFilters.forEach((filter, index) => { const filterRow = document.createElement('div'); filterRow.className = 'd-flex gap-1 align-items-center flex-grow-1'; const columnSelect = document.createElement('select'); columnSelect.dataset.index = index; columnSelect.className = 'form-select form-select-sm'; columnSelect.style.width = '150px'; columnSelect.innerHTML = '<option value="">Filtrar por...</option>' + Object.entries(filterableColumns).map(([key, {label}]) => `<option value="${key}" ${filter.column === key ? 'selected' : ''}>${label}</option>`).join(''); let valueElement; const filterColumnKey = filter.column; if (filterColumnKey && options[filterColumnKey]) { valueElement = document.createElement('select'); valueElement.id = `filter-value-${index}`; } else { valueElement = document.createElement('input'); valueElement.type = 'text'; valueElement.placeholder = 'Valor...'; valueElement.value = filter.value || ''; } valueElement.dataset.index = index; valueElement.className = 'filter-value form-control form-control-sm flex-grow-1'; valueElement.style.minWidth = '150px'; const removeBtn = document.createElement('button'); removeBtn.className = 'btn btn-sm btn-danger remove-filter-btn'; removeBtn.innerHTML = '&times;'; removeBtn.dataset.index = index; filterRow.append(columnSelect, valueElement, removeBtn); filterContainer.appendChild(filterRow); if (filterColumnKey && options[filterColumnKey]) { filterChoicesInstances[`filter-value-${index}`] = new Choices(valueElement, { choices: options[filterColumnKey].map(val => ({ value: val, label: val })), removeItemButton: false, searchResultLimit: 10, itemSelectText: '', placeholder: true, placeholderValue: 'Selecione', allowHTML: false }); if (filter.value) { filterChoicesInstances[`filter-value-${index}`].setChoiceByValue(filter.value); } } }); }
        function renderInfoToggleUI() { infoToggleDropdown.innerHTML = ''; Object.keys(fieldLabels).forEach(key => { const div = document.createElement('div'); div.className = 'form-check ms-2'; div.innerHTML = `<input class="form-check-input" type="checkbox" data-key="${key}" id="info-toggle-${key}" ${cardVisibility[key] ? 'checked' : ''}><label class="form-check-label" for="info-toggle-${key}">${fieldLabels[key]}</label>`; infoToggleDropdown.appendChild(div); }); }
        
        function getStatusBadge(status) { const statusClass = (status || 'sem-status').toLowerCase().replace(/\s+/g, '-'); return `<span class="status-badge status-${statusClass}">${status || 'N/A'}</span>`; }

        function renderAssetList() {
            const filteredAtivos = ativos.filter(ativo => { const searchMatch = quickSearchTerm === '' || Object.values(ativo).some(val => String(val).toLowerCase().includes(quickSearchTerm)); const filterMatch = activeFilters.every(filter => { if (!filter.column || !filter.value) return true; const ativoValue = ativo[filter.column]?.toString() || ''; if (options[filter.column]) { return ativoValue === filter.value; } else { return ativoValue.toLowerCase().includes(filter.value.toLowerCase()); } }); return searchMatch && filterMatch; });
            assetListContainer.innerHTML = '';
            if (filteredAtivos.length === 0) { assetListContainer.innerHTML = `<div class="col-12 text-center p-5 bg-dark bg-opacity-10 rounded">Nenhum ativo encontrado.</div>`;
            } else {
                filteredAtivos.forEach((ativo, i) => {
                    const originalIndex = ativos.indexOf(ativo);
                    let detailsHtml = Object.keys(fieldLabels).filter(key => cardVisibility[key] && ativo[key]).map(key => `<p class="mb-1 detail-item"><i class="bi bi-dot"></i> <strong>${fieldLabels[key]}:</strong> ${ativo[key]}</p>`).join('');
                    const card = document.createElement('div');
                    card.className = 'asset-card rounded p-3';
                    card.dataset.index = originalIndex;
                    card.style.animationDelay = `${i * 30}ms`;
                    card.innerHTML = `<div class="row g-3 align-items-center"><div class="col-auto"><a href="#" class="editable-image-container" data-index="${originalIndex}"><img src="${ativo.imageDataUrl || 'data:image/svg+xml,%3Csvg width="80" height="80" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80"%3E%3Crect width="80" height="80" fill="%23212529"%3E%3C/rect%3E%3Ctext x="50%" y="50%" fill="%23868e96" dy=".3em" text-anchor="middle"%3ESem Foto%3C/text%3E%3C/svg%3E'}" class="asset-image rounded"></a></div><div class="col"><div class="d-flex justify-content-between align-items-start"><div><h5 class="asset-card-title mb-0">${ativo.etiqueta || 'Sem Etiqueta'}</h5><small class="asset-card-subtitle">${ativo.tipoItem || 'N/A'}</small></div>${getStatusBadge(ativo.statusLocalizacao)}</div><hr class="my-2" style="border-color: var(--teal);"><div class="asset-card-details">${detailsHtml || '<p class="mb-1 detail-item">Nenhum detalhe para exibir.</p>'}</div></div><div class="col-auto d-flex flex-row flex-sm-column justify-content-end align-items-center gap-2"><div class="form-check"><input class="form-check-input row-checkbox" type="checkbox" data-index="${originalIndex}"></div><button class="btn btn-sm btn-outline-primary edit-btn" data-index="${originalIndex}" title="Editar Ativo"><i class="bi bi-pencil-fill"></i></button><button class="btn btn-sm btn-outline-danger remove-btn" data-index="${originalIndex}" title="Remover Ativo"><i class="bi bi-trash-fill"></i></button></div></div>`;
                    assetListContainer.appendChild(card);
                    setTimeout(() => card.classList.add('visible'), 0);
                });
            }
            updateBulkActionUI(); lastCheckedCheckbox = null;
        }

        async function handleQuickImageUpdate(dataUrl) { if (editingImageIndex === null) return; try { const ativo = ativos[editingImageIndex]; const compressedDataUrl = await compressImage(dataUrl, 800, 800, 0.7); ativo.imageDataUrl = compressedDataUrl; ativo.imageFilename = generateImageFilename(ativo.etiqueta, ativo.assetId); saveAtivos(); renderAssetList(); alert('Imagem atualizada!'); } catch (error) { alert('Falha ao atualizar imagem: ' + error.message); } finally { editingImageIndex = null; imageEditModal.hide(); cameraBootstrapModal.hide(); } }
        function toggleFloatingBar() { const wrapperRect = bulkActionsWrapper.getBoundingClientRect(); const isOutOfView = wrapperRect.bottom < 0 || wrapperRect.top > window.innerHeight; const hasSelection = document.querySelectorAll('.row-checkbox:checked').length > 0; floatingActionsBar.classList.toggle('show', isOutOfView && hasSelection); }
        function updateBulkActionUI() { const selectedCount = document.querySelectorAll('.row-checkbox:checked').length; const anySelected = selectedCount > 0; document.querySelectorAll('#bulk-actions-container button, #floating-actions-bar').forEach(el => el.style.display = 'none'); if (anySelected) { const text = `(${selectedCount})`; document.getElementById('bulk-actions-container').style.display = 'flex'; document.getElementById('bulk-edit-btn').style.display = 'inline-flex'; document.getElementById('bulk-delete-btn').style.display = 'inline-flex'; document.getElementById('bulk-delete-btn').innerHTML = `<i class="bi bi-trash me-1"></i>Excluir ${text}`; document.getElementById('bulk-edit-btn').innerHTML = `<i class="bi bi-pencil-square me-1"></i>Ação ${text}`; document.getElementById('floating-actions-bar').style.display = 'block'; document.getElementById('floating-selection-count').textContent = `${selectedCount} selecionado(s)`; document.getElementById('floating-bulk-delete-btn').innerHTML = `<i class="bi bi-trash me-1"></i>Excluir ${text}`; document.getElementById('floating-bulk-edit-btn').innerHTML = `<i class="bi bi-pencil-square me-1"></i>Ação ${text}`; } const allVisibleCheckboxes = document.querySelectorAll('.row-checkbox'); selectAllCheckbox.checked = allVisibleCheckboxes.length > 0 && selectedCount === allVisibleCheckboxes.length; selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < allVisibleCheckboxes.length; toggleFloatingBar(); }
        function handleBulkDelete() { const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked'); if (selectedCheckboxes.length === 0) return; if (confirm(`Excluir os ${selectedCheckboxes.length} ativos selecionados?`)) { const indicesToDelete = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index, 10)); ativos = ativos.filter((_, index) => !indicesToDelete.includes(index)); saveAtivos(); renderAssetList(); } }
        function openBulkEditModal() { const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked'); if (selectedCheckboxes.length === 0) return; renderBulkEditForm(); for (const key in bulkChoicesInstances) { if (bulkChoicesInstances[key]) { bulkChoicesInstances[key].destroy(); delete bulkChoicesInstances[key]; } } initializeChoices('bulk-', bulkChoicesInstances); document.getElementById('bulk-edit-count').textContent = selectedCheckboxes.length; bulkEditModal.show(); }
        function handleBulkEditSave() { const selectedIndices = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => parseInt(cb.dataset.index, 10)); if (selectedIndices.length === 0) return; let changesMade = false; selectedIndices.forEach(index => { const ativo = ativos[index]; bulkEditFields.forEach(field => { const bulkElement = document.getElementById(`bulk-${field}`); if (!bulkElement) return; let value; if (bulkChoicesInstances[`bulk-${field}`]) { value = bulkChoicesInstances[`bulk-${field}`].getValue(true); } else { value = bulkElement.value; } if (value !== null && value !== undefined && value !== '') { if (ativo[field] !== value) { ativo[field] = value; changesMade = true; } } }); }); if (changesMade) { saveAtivos(); renderAssetList(); alert(`${selectedIndices.length} ativos atualizados!`); } else { alert("Nenhuma alteração feita."); } bulkEditModal.hide(); }
        function initializeChoices(prefix = '', instanceObject = choicesInstances) { for (const id in options) { const selectElement = document.getElementById(`${prefix}${id}`); if (selectElement) { instanceObject[`${prefix}${id}`] = new Choices(selectElement, { choices: options[id].map(val => ({ value: val, label: val })), removeItemButton: prefix !== 'bulk-', searchResultLimit: 15, itemSelectText: '', placeholder: true, placeholderValue: 'Selecione', allowHTML: false }); } } const tipoItemElement = document.getElementById('tipoItem'); if (tipoItemElement) { tipoItemElement.addEventListener('change', toggleConditionalFields); } }
        function toggleConditionalFields() { const tipoItemSelect = choicesInstances['tipoItem']; if (!tipoItemSelect) return; const tipo = tipoItemSelect.getValue(true); const notebookFields = document.getElementById('notebook-fields'); const celularFields = document.getElementById('celular-fields'); if (notebookFields) notebookFields.style.display = ['Notebook', 'Desktop'].includes(tipo) ? 'flex' : 'none'; if (celularFields) celularFields.style.display = tipo === 'Celular' ? 'flex' : 'none'; }
        const getFormData = () => { const data = {}; formFields.forEach(id => { const element = document.getElementById(id); if (element) data[id] = choicesInstances[id] ? choicesInstances[id].getValue(true) : element.value; }); data.imageDataUrl = currentImageData.dataUrl; return data; };
        const setFormData = (ativo) => { formFields.forEach(id => { const element = document.getElementById(id); if (choicesInstances[id]) { if (ativo[id]) { choicesInstances[id].setChoiceByValue(String(ativo[id])); } else { choicesInstances[id].setChoiceByValue(''); } } else if (element) { element.value = ativo[id] || ''; } }); };
        function handleFormSubmit(e) { e.preventDefault(); const ativoData = getFormData(); if (editingIndex !== null) { const existingAsset = ativos[editingIndex]; ativoData.assetId = existingAsset.assetId; if (ativoData.imageDataUrl && ativoData.imageDataUrl !== existingAsset.imageDataUrl) { ativoData.imageFilename = generateImageFilename(ativoData.etiqueta, ativoData.assetId); } else { ativoData.imageFilename = existingAsset.imageFilename; ativoData.imageDataUrl = existingAsset.imageDataUrl; } ativos[editingIndex] = { ...existingAsset, ...ativoData }; } else { ativoData.assetId = Date.now().toString(36) + Math.random().toString(36).substring(2); if (ativoData.imageDataUrl) { ativoData.imageFilename = generateImageFilename(ativoData.etiqueta, ativoData.assetId); } ativos.push(ativoData); } saveAtivos(); resetFormMode(); renderAssetList(); alert(editingIndex !== null ? 'Ativo atualizado!' : 'Ativo cadastrado!'); bootstrap.Tab.getInstance('#list-tab-btn').show(); }
        function startEditing(index) { editingIndex = index; const ativo = ativos[index]; setFormData(ativo); const imagePreview = document.getElementById('image-preview'); currentImageData = { fileName: ativo.imageFilename, dataUrl: ativo.imageDataUrl }; if (ativo.imageDataUrl) { imagePreview.src = ativo.imageDataUrl; imagePreview.style.display = 'block'; } else { imagePreview.style.display = 'none'; } document.getElementById('submit-btn').textContent = 'Atualizar Ativo'; document.getElementById('cancel-edit-btn').style.display = 'inline-block'; bootstrap.Tab.getInstance('#form-tab-btn').show(); window.scrollTo({ top: 0, behavior: 'smooth' }); toggleConditionalFields(); };
        const generateImageFilename = (etiqueta, assetId) => { if (!etiqueta || !assetId) return null; const today = new Date(); const day = String(today.getDate()).padStart(2, '0'); const month = String(today.getMonth() + 1).padStart(2, '0'); const year = today.getFullYear(); const cleanEtiqueta = String(etiqueta).replace(/[^a-zA-Z0-9.-]/g, '_'); return `${cleanEtiqueta}_${assetId}_${day}${month}${year}.jpg`; };
        function resetFormMode() { editingIndex = null; form.reset(); for (const id in choicesInstances) { if (choicesInstances[id]) choicesInstances[id].setChoiceByValue(''); } const imagePreview = document.getElementById('image-preview'); if (imagePreview) { imagePreview.style.display = 'none'; imagePreview.src = ''; } currentImageData = { fileName: null, dataUrl: null }; document.getElementById('submit-btn').textContent = 'Salvar Ativo'; document.getElementById('cancel-edit-btn').style.display = 'none'; toggleConditionalFields(); };
        const escapeCsvCell = (cell) => { if (cell === null || cell === undefined) return ''; cell = String(cell); if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) { return `"${cell.replace(/"/g, '""')}"`; } return cell; };
        function exportToCsv() { if (ativos.length === 0) return alert('Nenhum ativo para exportar.'); const headers = [...formFields.filter(f => f !== 'imageDataUrl'), 'imageFilename']; const csvRows = [headers.join(',')]; ativos.forEach(ativo => csvRows.push(headers.map(header => escapeCsvCell(ativo[header])).join(','))); const blob = new Blob([csvRows.join('\r\n')], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'ativos.csv'; link.click(); }
        function exportSystemData() { if (ativos.length === 0) return alert('Nenhum dado para exportar.'); const zip = new JSZip(); const imagesFolder = zip.folder("images"); const ativosForExport = JSON.parse(JSON.stringify(ativos)); ativosForExport.forEach(ativo => { if (ativo.imageDataUrl && ativo.imageDataUrl.startsWith('data:image')) { const correctFilename = generateImageFilename(ativo.etiqueta, ativo.assetId); if (correctFilename) { const imageData = ativo.imageDataUrl.split(',')[1]; imagesFolder.file(correctFilename, imageData, { base64: true }); ativo.imageFilename = correctFilename; ativo.imageDataUrl = `images/${correctFilename}`; } else { delete ativo.imageDataUrl; delete ativo.imageFilename; } } else { delete ativo.imageDataUrl; delete ativo.imageFilename; } }); const appData = { assets: ativosForExport, settings: {} }; zip.file("data.json", JSON.stringify(appData, null, 2)); zip.generateAsync({ type: "blob" }).then(content => { const link = document.createElement('a'); link.href = URL.createObjectURL(content); link.download = 'gerenciador_de_ativos_backup.zip'; link.click(); }); }
        async function handleSystemImport(event) { const file = event.target.files[0]; if (!file) return; try { const zip = await JSZip.loadAsync(file); const dataFile = zip.file("data.json"); if (!dataFile) return alert('Arquivo de backup inválido.'); const content = await dataFile.async("string"); const appData = JSON.parse(content); if (confirm('Isso substituirá todos os dados atuais. Deseja continuar?')) { const importedAssets = appData.assets || []; for (const ativo of importedAssets) { if (!ativo.assetId) ativo.assetId = Date.now().toString(36) + Math.random().toString(36).substring(2); if (ativo.etiqueta) ativo.imageFilename = generateImageFilename(ativo.etiqueta, ativo.assetId) || ativo.imageFilename; if (ativo.imageDataUrl && typeof ativo.imageDataUrl === 'string' && ativo.imageDataUrl.startsWith('images/')) { const imageFile = zip.file(ativo.imageDataUrl); if (imageFile) { try { const base64Data = await imageFile.async("base64"); const mimeType = imageFile.name.endsWith('png') ? 'image/png' : 'image/jpeg'; ativo.imageDataUrl = await compressImage(`data:${mimeType};base64,${base64Data}`, 800, 800, 0.7); } catch (imgErr) { console.error(`Falha ao processar a imagem ${imageFile.name}.`, imgErr); ativo.imageDataUrl = null; ativo.imageFilename = null; } } } } ativos = importedAssets; saveAtivos(); renderAssetList(); alert('Dados importados com sucesso!'); } } catch (e) { alert('Erro ao processar o arquivo ZIP.'); console.error("Import Error:", e); } finally { event.target.value = ''; } }
        const compressImage = (dataUrl, maxWidth, maxHeight, quality) => { return new Promise((resolve, reject) => { if (!dataUrl) return reject(new Error("No image data.")); const img = new Image(); img.src = dataUrl; img.onload = () => { let width = img.width, height = img.height; if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } } const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; canvas.getContext('2d').drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', quality)); }; img.onerror = () => reject(new Error("Invalid image file.")); }); };
        function handleCsvImport(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { const text = e.target.result; const lines = text.split(/\r\n|\n/); if (lines.length < 2) return alert('CSV inválido.'); const parseCsvRow = r => { const regex = /(?:\")([^\"\\]*(?:\\\\[^\"\\]*)*)(?:\")|([^,]+)/g; let m, res = []; while (m = regex.exec(r)) { res.push(m[1] ? m[1].replace(/\\\"\\\"/g, '"') : m[2].trim()); } return res; }; const headers = parseCsvRow(lines[0]); const newAtivos = []; for (let i = 1; i < lines.length; i++) { if (!lines[i]) continue; const values = parseCsvRow(lines[i]); if (values.length === 0 || values.every(v => !v)) continue; const ativo = {}; headers.forEach((h, i) => { if (values[i] && formFields.includes(h)) ativo[h] = values[i]; }); if (Object.keys(ativo).length > 0) newAtivos.push(ativo); } if (newAtivos.length > 0) { if (confirm(`Adicionar ${newAtivos.length} ativos?`)) { ativos.push(...newAtivos); saveAtivos(); renderAssetList(); alert(`${newAtivos.length} ativos importados!`); } } else { alert('Nenhum ativo válido encontrado no CSV.'); } event.target.value = ''; }; reader.readAsText(file, 'UTF-8'); }
        function openCamera() { navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }).then(stream => { cameraStream = stream; document.getElementById('camera-stream').srcObject = stream; cameraBootstrapModal.show(); }).catch(() => alert("Não foi possível acessar a câmera.")); }
        function closeCamera() { if (cameraStream) cameraStream.getTracks().forEach(track => track.stop()); cameraStream = null; cameraBootstrapModal.hide(); }
        async function captureImage() { const videoElement = document.getElementById('camera-stream'); if (!videoElement || videoElement.readyState < 2) return; const canvas = document.createElement('canvas'); canvas.width = videoElement.videoWidth; canvas.height = videoElement.videoHeight; canvas.getContext('2d').drawImage(videoElement, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg'); if (editingImageIndex !== null) { await handleQuickImageUpdate(dataUrl); } else { try { const compressedDataUrl = await compressImage(dataUrl, 800, 800, 0.7); currentImageData = { fileName: `capture.jpg`, dataUrl: compressedDataUrl }; document.getElementById('image-preview').src = compressedDataUrl; document.getElementById('image-preview').style.display = 'block'; closeCamera(); } catch (error) { alert(error.message); closeCamera(); } } }
        
        window.addEventListener('scroll', () => { backToTopButton.classList.toggle('show', window.scrollY > 300); toggleFloatingBar(); });
        backToTopButton.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        form.addEventListener('submit', handleFormSubmit);
        form.addEventListener('click', (e) => { if (e.target.id === 'cancel-edit-btn') resetFormMode(); if (e.target.id === 'open-camera-btn') openCamera(); });
        form.addEventListener('change', e => { if (e.target.id === 'select-file-btn') { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = async (loadEvent) => { try { const compressedDataUrl = await compressImage(loadEvent.target.result, 800, 800, 0.7); currentImageData = { fileName: file.name, dataUrl: compressedDataUrl }; document.getElementById('image-preview').src = compressedDataUrl; document.getElementById('image-preview').style.display = 'block'; } catch (error) { alert(error.message); } }; reader.readAsDataURL(file); } } });
        document.getElementById('import-csv-input').addEventListener('change', handleCsvImport);
        document.getElementById('import-system-input').addEventListener('change', handleSystemImport);
        document.getElementById('export-csv-btn').addEventListener('click', exportToCsv);
        document.getElementById('export-system-btn').addEventListener('click', exportSystemData);
        assetListContainer.addEventListener('click', (e) => { const link = e.target.closest('a.editable-image-container'); const btn = e.target.closest('button'); if (link) { e.preventDefault(); editingImageIndex = parseInt(link.dataset.index, 10); imageEditModal.show(); } if (btn?.classList.contains('remove-btn')) { if (confirm('Tem certeza?')) { const index = parseInt(btn.dataset.index, 10); ativos.splice(index, 1); saveAtivos(); renderAssetList(); } } if (btn?.classList.contains('edit-btn')) { startEditing(parseInt(btn.dataset.index, 10)); } });
        assetListContainer.addEventListener('change', e => { if (e.target.classList.contains('row-checkbox')) { if (e.shiftKey && lastCheckedCheckbox) { const checkboxes = Array.from(assetListContainer.querySelectorAll('.row-checkbox')); const start = checkboxes.indexOf(lastCheckedCheckbox); const end = checkboxes.indexOf(e.target); const range = (start < end) ? checkboxes.slice(start, end + 1) : checkboxes.slice(end, start + 1); range.forEach(checkbox => checkbox.checked = lastCheckedCheckbox.checked); } lastCheckedCheckbox = e.target; updateBulkActionUI(); } });
        selectAllCheckbox.addEventListener('change', (e) => { document.querySelectorAll('#asset-list-container .row-checkbox').forEach(checkbox => { checkbox.checked = e.target.checked; }); updateBulkActionUI(); });
        ['bulk-delete-btn', 'floating-bulk-delete-btn'].forEach(id => document.getElementById(id)?.addEventListener('click', handleBulkDelete));
        ['bulk-edit-btn', 'floating-bulk-edit-btn'].forEach(id => document.getElementById(id)?.addEventListener('click', openBulkEditModal));
        document.getElementById('bulk-edit-modal').addEventListener('click', (e) => { if (e.target.id === 'save-bulk-edit-btn') handleBulkEditSave(); });
        document.getElementById('camera-modal').addEventListener('click', (e) => { if (e.target.id === 'capture-image-btn') captureImage(); });
        document.getElementById('camera-modal').addEventListener('hidden.bs.modal', () => { if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); cameraStream = null; } });
        addFilterBtn.addEventListener('click', () => { activeFilters.push({}); renderFilterControls(); renderAssetList(); });
        filterContainer.addEventListener('click', e => { if (e.target.classList.contains('remove-filter-btn')) { activeFilters.splice(e.target.dataset.index, 1); renderFilterControls(); renderAssetList(); } });
        filterContainer.addEventListener('change', e => { const index = e.target.dataset.index; if (e.target.matches('select.form-select-sm')) { activeFilters[index].column = e.target.value; activeFilters[index].value = ''; renderFilterControls(); renderAssetList(); } else if (e.target.classList.contains('filter-value')) { const choicesInstance = filterChoicesInstances[`filter-value-${index}`]; activeFilters[index].value = choicesInstance ? choicesInstance.getValue(true) : e.target.value; renderAssetList(); } });
        filterContainer.addEventListener('input', e => { if (e.target.classList.contains('filter-value') && e.target.tagName === 'INPUT') { activeFilters[e.target.dataset.index].value = e.target.value; renderAssetList(); } });
        quickImageUploadInput.addEventListener('change', (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (loadEvent) => handleQuickImageUpdate(loadEvent.target.result); reader.readAsDataURL(file); } e.target.value = ''; });
        quickImageCaptureBtn.addEventListener('click', () => { imageEditModal.hide(); openCamera(); });
        infoToggleDropdown.addEventListener('change', (e) => { const key = e.target.dataset.key; if (key) { cardVisibility[key] = e.target.checked; saveCardVisibility(); renderAssetList(); } });
        quickSearchInput.addEventListener('input', (e) => { quickSearchTerm = e.target.value.toLowerCase(); renderAssetList(); });
        
        renderMainForm();
        initializeChoices('', choicesInstances);
        renderFilterControls();
        renderInfoToggleUI();
        renderAssetList();
    });
    </script>
</body>
</html>
