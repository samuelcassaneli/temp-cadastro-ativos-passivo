<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gerenciador de Ativos</title>
    
    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#005C73">
    
    <!-- Bibliotecas Externas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --black: #000000; --tiffany-blue: #96D1D3; --midnight-green: #005C73; --teal: #01848C; --white: #f0f8ff; --shadow: rgba(0, 0, 0, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--midnight-green); color: var(--white); line-height: 1.6; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; background-color: rgba(1, 132, 140, 0.2); border-radius: 15px; box-shadow: 0 10px 30px var(--shadow); padding: 25px; backdrop-filter: blur(5px); }
        header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--tiffany-blue); padding-bottom: 15px; }
        header h1 { color: var(--tiffany-blue); font-size: 2.5rem; text-shadow: 1px 1px 3px var(--black); }
        .actions-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .btn, .btn-like-input-label { background: var(--teal); color: var(--white); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 10px var(--shadow); display: inline-block; text-align: center; }
        .btn:hover, .btn-like-input-label:hover { background: var(--tiffany-blue); color: var(--midnight-green); transform: translateY(-2px); box-shadow: 0 6px 15px var(--shadow); }
        .btn-edit { background-color: var(--tiffany-blue); color: var(--midnight-green); } .btn-edit:hover { background-color: #b0e0e6; color: var(--black); }
        .btn-danger { background-color: #c0392b; } .btn-danger:hover { background-color: #e74c3c; }
        .btn-secondary { background-color: #7f8c8d; } .btn-secondary:hover { background-color: #95a5a6; }
        input[type="file"] { display: none; }
        .tabs { display: flex; border-bottom: 2px solid var(--teal); margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; background: none; border: none; color: var(--tiffany-blue); font-size: 1.1rem; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab-button.active { color: var(--white); border-bottom-color: var(--tiffany-blue); }
        .tab-content { display: none; animation: fadeIn 0.5s; } .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #asset-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; color: var(--tiffany-blue); font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea, .search-input { width: 100%; padding: 10px; border: 1px solid var(--teal); background-color: rgba(0, 92, 115, 0.5); color: var(--white); border-radius: 5px; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus, .search-input:focus { outline: none; border-color: var(--tiffany-blue); box-shadow: 0 0 10px rgba(150, 209, 211, 0.5); }
        #image-preview-container { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; }
        #image-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        #image-preview { max-width: 150px; max-height: 150px; border-radius: 5px; border: 1px dashed var(--teal); display: none; }
        .form-actions { grid-column: 1 / -1; text-align: right; display: flex; gap: 10px; justify-content: flex-end; }
        .section-title { grid-column: 1 / -1; color: var(--tiffany-blue); border-bottom: 1px solid var(--teal); padding-bottom: 5px; margin-top: 20px; font-size: 1.2rem; }
        .table-container { overflow-x: auto; }
        #asset-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #asset-table th, #asset-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--midnight-green); white-space: nowrap; }
        #asset-table th:first-child, #asset-table td:first-child { text-align: center; } /* Centralizar checkbox */
        .asset-image-thumbnail { max-width: 60px; max-height: 60px; border-radius: 5px; cursor: pointer; transition: transform 0.2s; }
        .asset-image-thumbnail:hover { transform: scale(1.1); }
        #camera-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; flex-direction: column; gap: 20px; }
        #camera-feed { max-width: 80%; max-height: 70%; border-radius: 10px; }
        .modal-buttons { display: flex; gap: 20px; }
        .conditional-fields { display: none; grid-column: 1 / -1; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; border: 1px dashed var(--teal); padding: 15px; border-radius: 8px; margin-top: 10px; }
        .conditional-fields.visible { display: grid; }
        /* Estilos com melhor contraste para Choices.js */
        .choices { width: 100%; }
        .choices__inner { background-color: rgba(0, 92, 115, 0.5); border: 1px solid var(--teal); border-radius: 5px; padding: 7px; font-size: 1rem; color: var(--white); min-height: 44px; }
        .choices.is-open .choices__inner { border-color: var(--tiffany-blue); }
        .choices__list--dropdown { background-color: var(--midnight-green); border-color: var(--teal); }
        .choices__list[aria-expanded] { border-color: var(--teal); }
        .choices__item--choice { color: var(--white); }
        .choices__item--choice.is-highlighted { background-color: var(--tiffany-blue); color: var(--midnight-green); }
        .choices__item--selectable { background-color: var(--teal); border: 1px solid var(--tiffany-blue); }
        .choices__button { border-left: 1px solid rgba(255, 255, 255, 0.5); filter: invert(1); opacity: 0.75; }
        .choices__button:hover { opacity: 1; }
        .choices__placeholder { color: var(--tiffany-blue); opacity: 0.8; }
        .choices[data-type*="select-one"]::after { border-color: var(--white) transparent transparent; }
        .choices.is-open[data-type*="select-one"]::after { border-color: transparent transparent var(--white); margin-top: -2.5px; }
        /* Estilo para o aviso de "Sair do App" */
        #exit-toast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background-color: var(--black); color: var(--white); padding: 12px 25px;
            border-radius: 25px; font-size: 0.9rem; z-index: 2000;
            transition: bottom 0.4s ease-in-out; box-shadow: 0 5px 15px var(--shadow);
        }
        #exit-toast.show { bottom: 30px; }

        /* NOVOS ESTILOS para Pesquisa e Ações em Massa */
        .list-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .search-container { flex-grow: 1; min-width: 250px; }
        #bulk-delete-btn { display: none; } /* Escondido por padrão */
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Gerenciador de Ativos</h1></header>
        <div class="actions-bar">
            <button id="export-csv-btn" class="btn">Exportar CSV</button>
            <button id="export-system-btn" class="btn">Exportar Sistema (ZIP)</button>
            <label for="import-system-input" class="btn-like-input-label">Importar Sistema (ZIP)</label>
            <input type="file" id="import-system-input" accept=".zip">
        </div>
        <div class="tabs">
            <button id="form-tab-btn" class="tab-button active" data-tab="tab-form">Cadastrar Ativo</button>
            <button class="tab-button" data-tab="tab-list">Lista de Ativos</button>
        </div>

        <!-- ABA DE CADASTRO -->
        <div id="tab-form" class="tab-content active">
            <form id="asset-form">
                <!-- Conteúdo do formulário (sem alterações) -->
                <h3 class="section-title">Informações do Ativo</h3>
                <div class="form-group"><label for="etiqueta">Etiqueta de Patrimônio</label><input type="text" id="etiqueta" required></div>
                <div class="form-group"><label for="tipoItem">Tipo do Item</label><select id="tipoItem"></select></div>
                <div class="form-group"><label for="marca">Marca</label><input type="text" id="marca"></div>
                <div class="form-group"><label for="modelo">Modelo</label><input type="text" id="modelo"></div>
                <div class="form-group"><label for="nSerie">N. Série</label><input type="text" id="nSerie"></div>
                <div class="form-group" style="grid-column: 1 / -1;"><label>Imagem do Ativo</label><div id="image-preview-container"><div id="image-controls"><button type="button" id="open-camera-btn" class="btn">Capturar Imagem</button><label for="select-file-btn" class="btn-like-input-label">Selecionar Arquivo</label><input type="file" id="select-file-btn" accept="image/*"></div><img id="image-preview" src="" alt="Pré-visualização da Imagem"></div></div>
                <div id="celular-fields" class="conditional-fields"><h3 class="section-title">Detalhes do Celular</h3><div class="form-group"><label for="imei1">IMEI 1</label><input type="text" id="imei1"></div><div class="form-group"><label for="imei2">IMEI 2</label><input type="text" id="imei2"></div><div class="form-group"><label for="numeroTelefone">Número de Telefone Vinculado</label><input type="text" id="numeroTelefone"></div></div>
                <div id="notebook-fields" class="conditional-fields"><h3 class="section-title">Especificações do Notebook</h3><div class="form-group"><label for="processador">Processador</label><select id="processador"></select></div><div class="form-group"><label for="memoriaRam">Memória RAM</label><select id="memoriaRam"></select></div><div class="form-group"><label for="memoriaRom">Memória ROM (Armazenamento)</label><select id="memoriaRom"></select></div><div class="form-group"><label for="placaDeVideo">Placa de Vídeo?</label><select id="placaDeVideo"></select></div></div>
                <h3 class="section-title">Status e Localização</h3>
                <div class="form-group"><label for="statusLocalizacao">Status Localização</label><select id="statusLocalizacao"></select></div><div class="form-group"><label for="usuario">Usuário</label><input type="text" id="usuario"></div><div class="form-group"><label for="empresa">Empresa</label><select id="empresa"></select></div><div class="form-group"><label for="dpto">Departamento</label><select id="dpto"></select></div><div class="form-group"><label for="unidade">Unidade</label><select id="unidade"></select></div><div class="form-group"><label for="localizacao">Localização Física</label><input type="text" id="localizacao"></div>
                <h3 class="section-title">Condição e Descrição</h3>
                <div class="form-group"><label for="estadoBem">Estado do Bem</label><select id="estadoBem"></select></div><div class="form-group"><label for="descarte">Descarte</label><select id="descarte"></select></div><div class="form-group" style="grid-column: 1 / -1;"><label for="descricao">Descrição</label><textarea id="descricao" rows="3"></textarea></div>
                <h3 class="section-title">Informações Contábeis e de Compra</h3>
                <div class="form-group"><label for="classificacaoContabil">Classificação Contábil</label><select id="classificacaoContabil"></select></div><div class="form-group"><label for="proprietario">Proprietário</label><input type="text" id="proprietario"></div><div class="form-group"><label for="notaFiscal">Nota Fiscal</label><input type="text" id="notaFiscal"></div><div class="form-group"><label for="valor">Valor (R$)</label><input type="number" id="valor" step="0.01"></div><div class="form-group"><label for="dataCompra">Data da Compra</label><input type="date" id="dataCompra"></div>
                <div class="form-actions"><button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display: none;">Cancelar Edição</button><button type="submit" id="submit-btn" class="btn">Salvar Ativo</button></div>
            </form>
        </div>

        <!-- ABA DE LISTA DE ATIVOS (COM AS NOVIDADES) -->
        <div id="tab-list" class="tab-content">
            <!-- NOVOS CONTROLES: PESQUISA E BOTÃO DE EXCLUSÃO -->
            <div class="list-controls">
                <div class="search-container">
                    <input type="search" id="search-input" class="search-input" placeholder="Pesquisar ativos...">
                </div>
                <button id="bulk-delete-btn" class="btn btn-danger">Excluir Selecionados</button>
            </div>

            <div class="table-container">
                <table id="asset-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-checkbox" title="Selecionar Todos"></th>
                            <th>Imagem</th><th>Etiqueta</th><th>Empresa</th><th>Tipo</th><th>Status Loc.</th><th>Unidade</th><th>Usuário</th><th>Localização</th><th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="asset-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAIS E TOAST (Sem alterações) -->
    <div id="camera-modal"><video id="camera-feed" playsinline autoplay></video><div class="modal-buttons"><button id="snap-photo-btn" class="btn">Tirar Foto</button><button id="cancel-camera-btn" class="btn btn-danger">Cancelar</button></div></div>
    <div id="exit-toast">Pressione voltar novamente para sair</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SELETORES DE ELEMENTOS ---
        const STORAGE_KEY = 'gerenciadorDeAtivosData';
        const form = document.getElementById('asset-form');
        const tableBody = document.getElementById('asset-table-body');
        const exportSystemBtn = document.getElementById('export-system-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const importSystemInput = document.getElementById('import-system-input');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const formTabBtn = document.getElementById('form-tab-btn');
        const imagePreview = document.getElementById('image-preview');
        const etiquetaInput = document.getElementById('etiqueta');
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const openCameraBtn = document.getElementById('open-camera-btn');
        const selectFileBtn = document.getElementById('select-file-btn');
        const cameraModal = document.getElementById('camera-modal');
        const cameraFeed = document.getElementById('camera-feed');
        const snapPhotoBtn = document.getElementById('snap-photo-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const notebookFields = document.getElementById('notebook-fields');
        const celularFields = document.getElementById('celular-fields');
        // NOVOS SELETORES
        const searchInput = document.getElementById('search-input');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');

        let editingIndex = null;
        let currentImageData = { fileName: null, dataUrl: null };
        let cameraStream = null;
        const choicesInstances = {};

        // --- LÓGICA DE PERSISTÊNCIA DE DADOS (Sem alterações) ---
        const loadAtivos = () => { try { const data = localStorage.getItem(STORAGE_KEY); return data ? JSON.parse(data) : []; } catch (e) { console.error("Erro ao carregar dados:", e); return []; } };
        const saveAtivos = () => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(ativos)); } catch (e) { console.error("Erro ao salvar dados:", e); alert("Não foi possível salvar os dados. Armazenamento cheio?"); } };
        let ativos = loadAtivos();

        // --- OPÇÕES DOS MENUS (Adicionei "Apoio de Pé") ---
        const options = {
            empresa: ['PPay', 'MNTZZ', 'VG'],
            tipoItem: ["Notebook", "Celular", "Desktop", "Fonte Notebook", "Radio Comunicador", "Monitor", "Apoio de Pé", "Teclado", "Mouse", "Tablet", "Carregador", "Câmera de Segurança", "Headset", "Suporte Papel Higiênico", "Suporte Sabão Líquido", "Suporte Papel Toalha", "Espelho", "Proteção de Ar Condicionado", "Webcam", "Impressora", "Scanner", "Nobreak (UPS)", "Roteador", "Switch", "Servidor", "Projetor", "TV", "Mesa", "Cadeira", "Cadeira de Escritório", "Cadeira de Reunião", "Armário", "Gaveteiro", "Estante", "Sofá", "Poltrona", "Quadro Branco", "Lixeira", "Geladeira", "Micro-ondas", "Bebedouro", "Cafeteira", "Ar Condicionado", "Ventilador", "Extintor de Incêndio", "Outro"],
            statusLocalizacao: ['Em estoque', 'Em uso', 'Em manutenção', 'Para descarte'],
            dpto: ["FACILITIES", "TI", "INFRA", "CS", "JURIDICO", "FINANCEIRO", "MARKETING", "EVENTOS", "ADM", "DIRETORIA"],
            unidade: ['TERRACINHO', 'MATRIZ', 'PO'],
            classificacaoContabil: ["Móveis e Utensílios", "Computadores e Periféricos", "Aparelhos telefônicos", "Bens de pequeno valor", "Máquinas e equipamentos", "Adornos"],
            estadoBem: ['Novo', 'Bom', 'Regular', 'Ruim', 'Sucata'],
            descarte: ['Não', 'Sim'],
            processador: ['i3', 'i5', 'i7', 'Ryzen 3', 'Ryzen 5', 'Ryzen 7'],
            memoriaRam: ['4GB', '8GB', '12GB', '16GB', '32GB'],
            memoriaRom: ['128GB SSD', '256GB SSD', '512GB SSD', '1TB SSD', '500GB HDD', '1TB HDD'],
            placaDeVideo: ['Não', 'Sim']
        };
        const formFields = ['etiqueta', 'statusLocalizacao', 'tipoItem', 'marca', 'modelo', 'nSerie', 'imei1', 'imei2', 'descricao', 'classificacaoContabil', 'localizacao', 'usuario', 'empresa', 'dpto', 'unidade', 'notaFiscal', 'valor', 'dataCompra', 'estadoBem', 'descarte', 'proprietario', 'numeroTelefone', 'processador', 'memoriaRam', 'memoriaRom', 'placaDeVideo'];

        // --- FUNÇÃO DE RENDERIZAÇÃO DA TABELA (MODIFICADA) ---
        function renderTable() {
            tableBody.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase().trim();

            const filteredAtivos = ativos.filter(ativo => {
                if (!searchTerm) return true; // Mostra todos se a busca estiver vazia
                const searchableString = [
                    ativo.etiqueta, ativo.tipoItem, ativo.marca,
                    ativo.modelo, ativo.nSerie, ativo.usuario, ativo.localizacao
                ].join(' ').toLowerCase();
                return searchableString.includes(searchTerm);
            });

            if (filteredAtivos.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding: 20px;">Nenhum ativo encontrado.</td></tr>`;
            } else {
                filteredAtivos.forEach(ativo => {
                    const originalIndex = ativos.indexOf(ativo); // Pega o índice original para edição/exclusão
                    const row = document.createElement('tr');
                    const imageCell = ativo.imageDataUrl ? `<a href="${ativo.imageDataUrl}" target="_blank"><img src="${ativo.imageDataUrl}" class="asset-image-thumbnail" alt="${ativo.imageFilename || ''}"></a>` : 'N/A';
                    
                    row.innerHTML = `
                        <td><input type="checkbox" class="row-checkbox" data-index="${originalIndex}"></td>
                        <td>${imageCell}</td>
                        <td>${ativo.etiqueta || ''}</td>
                        <td>${ativo.empresa || ''}</td>
                        <td>${ativo.tipoItem || ''}</td>
                        <td>${ativo.statusLocalizacao || ''}</td>
                        <td>${ativo.unidade || ''}</td>
                        <td>${ativo.usuario || ''}</td>
                        <td>${ativo.localizacao || ''}</td>
                        <td class="actions-cell">
                            <button class="btn btn-edit edit-btn" data-index="${originalIndex}">Editar</button>
                            <button class="btn btn-danger remove-btn" data-index="${originalIndex}">Remover</button>
                        </td>`;
                    tableBody.appendChild(row);
                });
            }
            updateBulkActionUI(); // Garante que a UI de ações em massa esteja correta
        };

        // --- NOVAS FUNÇÕES: AÇÕES EM MASSA E UI ---
        function updateBulkActionUI() {
            const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            const allVisibleCheckboxes = document.querySelectorAll('.row-checkbox');
            
            if (selectedCheckboxes.length > 0) {
                bulkDeleteBtn.style.display = 'inline-block';
                bulkDeleteBtn.textContent = `Excluir ${selectedCheckboxes.length} Selecionados`;
            } else {
                bulkDeleteBtn.style.display = 'none';
            }

            // Atualiza o checkbox "Selecionar Todos"
            if (allVisibleCheckboxes.length > 0 && selectedCheckboxes.length === allVisibleCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedCheckboxes.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }
        
        function handleBulkDelete() {
            const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            if (selectedCheckboxes.length === 0) return;
            
            if (confirm(`Tem certeza que deseja excluir os ${selectedCheckboxes.length} ativos selecionados? Esta ação não pode ser desfeita.`)) {
                const indicesToDelete = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index, 10));
                
                // Filtra o array, mantendo apenas os itens cujo índice NÃO está na lista de exclusão
                ativos = ativos.filter((_, index) => !indicesToDelete.includes(index));

                saveAtivos();
                renderTable(); // Re-renderiza a tabela com os dados atualizados
            }
        }
        
        // --- RESTANTE DO SCRIPT (com pequenas modificações para chamar saveAtivos e renderTable) ---
        function initializeChoices() { /* ...código sem alterações... */ for (const id in options) { const selectElement = document.getElementById(id); if (selectElement) { choicesInstances[id] = new Choices(selectElement, { choices: options[id].map(val => ({ value: val, label: val })), removeItemButton: true, searchResultLimit: 15, itemSelectText: 'Pressione para selecionar', placeholder: true, placeholderValue: 'Selecione uma opção' }); } } const tipoItemElement = document.getElementById('tipoItem'); if (tipoItemElement) { tipoItemElement.addEventListener('change', toggleConditionalFields); } }
        function toggleConditionalFields() { /* ...código sem alterações... */ const tipo = choicesInstances['tipoItem'] ? choicesInstances['tipoItem'].getValue(true) : ''; notebookFields.classList.toggle('visible', tipo === 'Notebook'); celularFields.classList.toggle('visible', tipo === 'Celular'); if (tipo !== 'Notebook') { ['processador', 'memoriaRam', 'memoriaRom', 'placaDeVideo'].forEach(id => choicesInstances[id]?.setValue([])); } if (tipo !== 'Celular') { ['imei1', 'imei2', 'numeroTelefone'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; }); } }
        async function openCamera() { /* ...código sem alterações... */ try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); cameraFeed.srcObject = cameraStream; cameraModal.style.display = 'flex'; } catch (err) { alert("Não foi possível acessar a câmera. Verifique as permissões."); } }
        function closeCamera() { /* ...código sem alterações... */ if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); } cameraModal.style.display = 'none'; }
        function takePicture() { /* ...código sem alterações... */ const canvas = document.createElement('canvas'); canvas.width = cameraFeed.videoWidth; canvas.height = cameraFeed.videoHeight; canvas.getContext('2d').drawImage(cameraFeed, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg', 0.9); const baseName = etiquetaInput.value.trim().replace(/\s+/g, '-') || 'ativo'; currentImageData = { fileName: `${baseName}-${Date.now()}.jpg`, dataUrl: dataUrl }; imagePreview.src = dataUrl; imagePreview.style.display = 'block'; closeCamera(); }
        function dataURLtoBlob(dataurl) { /* ...código sem alterações... */ let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n); while(n--){ u8arr[n] = bstr.charCodeAt(n); } return new Blob([u8arr], {type:mime}); }
        function getFormData() { /* ...código sem alterações... */ const data = {}; formFields.forEach(id => { const element = document.getElementById(id); if (element) data[id] = choicesInstances[id] ? choicesInstances[id].getValue(true) : element.value; }); data.imageFilename = currentImageData.fileName; data.imageDataUrl = currentImageData.dataUrl; return data; };
        function setFormData(ativo) { /* ...código sem alterações... */ formFields.forEach(id => { const element = document.getElementById(id); if (choicesInstances[id]) { choicesInstances[id].clearStore(); if(ativo[id]) choicesInstances[id].setValue([ativo[id]]); else choicesInstances[id].setChoiceByValue(''); } else if (element) { element.value = ativo[id] || ''; } }); };
        function handleFormSubmit(e) { e.preventDefault(); const ativoData = getFormData(); if (editingIndex !== null) { ativos[editingIndex] = ativoData; alert('Ativo atualizado!'); } else { ativos.push(ativoData); alert('Ativo cadastrado!'); } saveAtivos(); resetFormMode(); renderTable(); };
        function startEditing(index) { editingIndex = index; const ativo = ativos[index]; setFormData(ativo); currentImageData = { fileName: ativo.imageFilename, dataUrl: ativo.imageDataUrl }; if (ativo.imageDataUrl) { imagePreview.src = ativo.imageDataUrl; imagePreview.style.display = 'block'; } else { imagePreview.style.display = 'none'; } submitBtn.textContent = 'Atualizar Ativo'; cancelEditBtn.style.display = 'inline-block'; formTabBtn.click(); window.scrollTo({ top: 0, behavior: 'smooth' }); toggleConditionalFields(); };
        function resetFormMode() { editingIndex = null; form.reset(); for (const id in choicesInstances) { choicesInstances[id].setChoiceByValue(''); } imagePreview.style.display = 'none'; imagePreview.src = ''; currentImageData = { fileName: null, dataUrl: null }; submitBtn.textContent = 'Salvar Ativo'; cancelEditBtn.style.display = 'none'; toggleConditionalFields(); };
        async function exportToSystem() { /* ...código sem alterações... */ if (ativos.length === 0) return alert('Não há dados para exportar.'); alert('Gerando arquivo ZIP...'); const zip = new JSZip(); zip.file("backup_ativos.json", JSON.stringify(ativos, null, 2)); const imgFolder = zip.folder("images"); ativos.forEach(ativo => { if (ativo.imageDataUrl && ativo.imageFilename) { const blob = dataURLtoBlob(ativo.imageDataUrl); imgFolder.file(ativo.imageFilename, blob); } }); try { const content = await zip.generateAsync({ type: "blob" }); const a = document.createElement("a"); a.href = URL.createObjectURL(content); a.download = `backup_completo_${new Date().toISOString().slice(0,10)}.zip`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); } catch(e) { console.error(e); alert("Ocorreu um erro ao gerar o arquivo ZIP."); } };
        async function importFromSystem(e) { /* ...código sem alterações... */ const file = e.target.files[0]; if (!file) return; alert('Lendo arquivo ZIP...'); try { const zip = await JSZip.loadAsync(file); const jsonFile = zip.file("backup_ativos.json"); if (!jsonFile) throw new Error("'backup_ativos.json' não encontrado."); const jsonContent = await jsonFile.async("string"); let importedAtivos = JSON.parse(jsonContent); const imageMap = new Map(); const imageFolder = zip.folder("images"); const imagePromises = []; if(imageFolder) { imageFolder.forEach((relativePath, zipEntry) => { const promise = zipEntry.async("base64").then(base64 => { const mimeType = zipEntry.name.endsWith('png') ? 'image/png' : 'image/jpeg'; imageMap.set(zipEntry.name, `data:${mimeType};base64,${base64}`); }); imagePromises.push(promise); }); } await Promise.all(imagePromises); importedAtivos.forEach(ativo => { if (ativo.imageFilename && imageMap.has(ativo.imageFilename)) { ativo.imageDataUrl = imageMap.get(ativo.imageFilename); } }); if (confirm('Dados lidos. Deseja substituir os dados atuais?')) { ativos = importedAtivos; saveAtivos(); resetFormMode(); renderTable(); alert('Sistema restaurado com sucesso!'); } } catch(e) { console.error(e); alert("Erro ao importar ZIP: " + e.message); } e.target.value = null; };
        function exportToCsv() { /* ...código sem alterações... */ if (ativos.length === 0) return alert('Não há dados para exportar.'); alert('Gerando CSV...'); const headers = ['ETIQUETA DE PATRIMÔNIO', 'Status.localizacao', 'Tipo.item', 'Marca', 'Modelo', 'N.Série', 'IMEI.1', 'IMEI.2', 'Descrição', 'Classificação Contábil', 'Localização', 'Usuário', 'Empresa', 'Dpto', 'Unidade', 'Nota Fiscal', 'Valor', 'Data da Compra', 'Estado do bem', 'Descarte', 'Proprietário', 'Processador', 'Memória RAM', 'Memória ROM', 'Placa de Video', 'Número de Telefone', 'Nome Arquivo Imagem']; const rows = ativos.map(ativo => { return [ ativo.etiqueta, ativo.statusLocalizacao, ativo.tipoItem, ativo.marca, ativo.modelo, ativo.nSerie, ativo.imei1, ativo.imei2, ativo.descricao, ativo.classificacaoContabil, ativo.localizacao, ativo.usuario, ativo.empresa, ativo.dpto, ativo.unidade, ativo.notaFiscal, ativo.valor, ativo.dataCompra, ativo.estadoBem, ativo.descarte, ativo.proprietario, ativo.processador, ativo.memoriaRam, ativo.memoriaRom, ativo.placaDeVideo, ativo.numeroTelefone, ativo.imageFilename || '' ].map(val => `"${(val || '').toString().replace(/"/g, '""')}"`).join(';'); }); const csvContent = "\uFEFF" + headers.join(';') + '\n' + rows.join('\n'); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `export_ativos_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        // --- LÓGICA DE SAÍDA DO APP (Sem alterações) ---
        let backButtonPressedOnce = false; window.addEventListener('popstate', (e) => { if (window.matchMedia('(display-mode: fullscreen)').matches) { if (backButtonPressedOnce) { history.back(); return; } e.preventDefault(); history.pushState(null, '', location.href); backButtonPressedOnce = true; const toast = document.getElementById('exit-toast'); toast.classList.add('show'); setTimeout(() => { backButtonPressedOnce = false; toast.classList.remove('show'); }, 2000); } }); history.pushState(null, '', location.href);

        // --- EVENT LISTENERS (Com as novas adições) ---
        form.addEventListener('submit', handleFormSubmit);
        cancelEditBtn.addEventListener('click', resetFormMode);
        openCameraBtn.addEventListener('click', openCamera);
        cancelCameraBtn.addEventListener('click', closeCamera);
        snapPhotoBtn.addEventListener('click', takePicture);
        exportSystemBtn.addEventListener('click', exportToSystem);
        exportCsvBtn.addEventListener('click', exportToCsv);
        importSystemInput.addEventListener('change', importFromSystem);
        selectFileBtn.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { const baseName = etiquetaInput.value.trim().replace(/\s+/g, '-') || 'ativo'; const uniqueFilename = `${baseName}-${Date.now()}.${file.name.split('.').pop()}`; imagePreview.src = event.target.result; imagePreview.style.display = 'block'; currentImageData = { fileName: uniqueFilename, dataUrl: event.target.result }; }; reader.readAsDataURL(file); } });
        tabs.forEach(tab => tab.addEventListener('click', (e) => { tabs.forEach(t => t.classList.remove('active')); tabContents.forEach(c => c.classList.remove('active')); e.currentTarget.classList.add('active'); document.getElementById(e.currentTarget.dataset.tab).classList.add('active'); }));
        
        tableBody.addEventListener('click', (e) => {
            // Exclusão/Edição individual
            if (e.target.classList.contains('remove-btn')) { if (confirm('Tem certeza?')) { const index = parseInt(e.target.dataset.index, 10); ativos.splice(index, 1); if (editingIndex === index) resetFormMode(); saveAtivos(); renderTable(); } }
            if (e.target.classList.contains('edit-btn')) { startEditing(parseInt(e.target.dataset.index, 10)); }
            // Atualiza UI de ações em massa se um checkbox foi clicado
            if (e.target.classList.contains('row-checkbox')) { updateBulkActionUI(); }
        });
        
        // NOVOS EVENT LISTENERS
        searchInput.addEventListener('input', renderTable); // Filtra a tabela ao digitar
        bulkDeleteBtn.addEventListener('click', handleBulkDelete);
        selectAllCheckbox.addEventListener('click', (e) => {
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateBulkActionUI();
        });

        // --- INICIALIZAÇÃO ---
        initializeChoices();
        renderTable();
        toggleConditionalFields();
    });

    // --- REGISTRO DO SERVICE WORKER (Sem alterações) ---
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(registration => { console.log('SW registrado:', registration.scope); }, err => { console.log('SW falhou:', err); }); }); }
    </script>
</body>
</html>
