<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Ativos</title>
    <!-- Biblioteca para menus suspensos com busca -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <!-- Biblioteca para manipulação de arquivos ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --black: #000000; --tiffany-blue: #96D1D3; --midnight-green: #005C73; --teal: #01848C; --white: #f0f8ff; --shadow: rgba(0, 0, 0, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--midnight-green); color: var(--white); line-height: 1.6; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; background-color: rgba(1, 132, 140, 0.2); border-radius: 15px; box-shadow: 0 10px 30px var(--shadow); padding: 25px; backdrop-filter: blur(5px); }
        header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--tiffany-blue); padding-bottom: 15px; }
        header h1 { color: var(--tiffany-blue); font-size: 2.5rem; text-shadow: 1px 1px 3px var(--black); }
        .actions-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .btn, .btn-like-input-label { background: var(--teal); color: var(--white); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 10px var(--shadow); display: inline-block; text-align: center; }
        .btn:hover, .btn-like-input-label:hover { background: var(--tiffany-blue); color: var(--midnight-green); transform: translateY(-2px); box-shadow: 0 6px 15px var(--shadow); }
        .btn-edit { background-color: var(--tiffany-blue); color: var(--midnight-green); } .btn-edit:hover { background-color: #b0e0e6; color: var(--black); }
        .btn-danger { background-color: #c0392b; } .btn-danger:hover { background-color: #e74c3c; }
        .btn-secondary { background-color: #7f8c8d; } .btn-secondary:hover { background-color: #95a5a6; }
        input[type="file"] { display: none; }
        .tabs { display: flex; border-bottom: 2px solid var(--teal); margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; background: none; border: none; color: var(--tiffany-blue); font-size: 1.1rem; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab-button.active { color: var(--white); border-bottom-color: var(--tiffany-blue); }
        .tab-content { display: none; animation: fadeIn 0.5s; } .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #asset-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; color: var(--tiffany-blue); font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--teal); background-color: rgba(0, 92, 115, 0.5); color: var(--white); border-radius: 5px; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--tiffany-blue); box-shadow: 0 0 10px rgba(150, 209, 211, 0.5); }
        #image-preview-container { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; }
        #image-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        #image-preview { max-width: 150px; max-height: 150px; border-radius: 5px; border: 1px dashed var(--teal); display: none; }
        .form-actions { grid-column: 1 / -1; text-align: right; display: flex; gap: 10px; justify-content: flex-end; }
        .section-title { grid-column: 1 / -1; color: var(--tiffany-blue); border-bottom: 1px solid var(--teal); padding-bottom: 5px; margin-top: 20px; font-size: 1.2rem; }
        .table-container { overflow-x: auto; }
        #asset-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #asset-table th, #asset-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--midnight-green); white-space: nowrap; }
        .asset-image-thumbnail { max-width: 60px; max-height: 60px; border-radius: 5px; cursor: pointer; transition: transform 0.2s; }
        .asset-image-thumbnail:hover { transform: scale(1.1); }
        
        #camera-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; flex-direction: column; gap: 20px; }
        #camera-feed { max-width: 80%; max-height: 70%; border-radius: 10px; }
        .modal-buttons { display: flex; gap: 20px; }

        /* Estilos com melhor contraste para Choices.js */
        .choices { width: 100%; }
        .choices__inner { background-color: rgba(0, 92, 115, 0.5); border: 1px solid var(--teal); border-radius: 5px; padding: 7px; font-size: 1rem; color: var(--white); min-height: 44px; }
        .choices.is-open .choices__inner { border-color: var(--tiffany-blue); }
        .choices__list--dropdown { background-color: var(--midnight-green); border-color: var(--teal); }
        .choices__list[aria-expanded] { border-color: var(--teal); }
        .choices__item--choice { color: var(--white); }
        .choices__item--choice.is-highlighted { background-color: var(--tiffany-blue); color: var(--midnight-green); }
        .choices__item--selectable { background-color: var(--teal); border: 1px solid var(--tiffany-blue); }
        .choices__button { border-left: 1px solid rgba(255, 255, 255, 0.5); filter: invert(1); opacity: 0.75; }
        .choices__button:hover { opacity: 1; }
        .choices__placeholder { color: var(--tiffany-blue); opacity: 0.8; }
        .choices[data-type*="select-one"]::after { border-color: var(--white) transparent transparent; }
        .choices.is-open[data-type*="select-one"]::after { border-color: transparent transparent var(--white); margin-top: -2.5px; }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Gerenciador de Ativos</h1></header>
        <div class="actions-bar">
            <button id="export-csv-btn" class="btn">Exportar CSV (Nomes)</button>
            <button id="export-system-btn" class="btn">Exportar Sistema (ZIP)</button>
            <label for="import-system-input" class="btn-like-input-label">Importar Sistema (ZIP)</label>
            <input type="file" id="import-system-input" accept=".zip">
        </div>
        <div class="tabs">
            <button id="form-tab-btn" class="tab-button active" data-tab="tab-form">Cadastrar Ativo</button>
            <button class="tab-button" data-tab="tab-list">Lista de Ativos</button>
        </div>
        <div id="tab-form" class="tab-content active">
            <form id="asset-form">
                <h3 class="section-title">Informações do Ativo</h3>
                <div class="form-group"><label for="etiqueta">Etiqueta de Patrimônio</label><input type="text" id="etiqueta" required></div>
                <div class="form-group"><label for="tipoItem">Tipo do Item</label><select id="tipoItem"></select></div>
                <div class="form-group"><label for="marca">Marca</label><input type="text" id="marca"></div>
                <div class="form-group"><label for="modelo">Modelo</label><input type="text" id="modelo"></div>
                <div class="form-group"><label for="nSerie">N. Série</label><input type="text" id="nSerie"></div>
                <div class="form-group"><label for="imei1">IMEI 1</label><input type="text" id="imei1"></div>
                <div class="form-group"><label for="imei2">IMEI 2</label><input type="text" id="imei2"></div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Imagem do Ativo</label>
                    <div id="image-preview-container">
                        <div id="image-controls">
                            <button type="button" id="open-camera-btn" class="btn">Capturar Imagem</button>
                            <label for="select-file-btn" class="btn-like-input-label">Selecionar Arquivo</label>
                            <input type="file" id="select-file-btn" accept="image/*">
                        </div>
                        <img id="image-preview" src="" alt="Pré-visualização da Imagem">
                    </div>
                </div>

                <h3 class="section-title">Status e Localização</h3>
                <div class="form-group"><label for="statusLocalizacao">Status Localização</label><select id="statusLocalizacao"></select></div>
                <div class="form-group"><label for="usuario">Usuário</label><input type="text" id="usuario"></div>
                <div class="form-group"><label for="empresa">Empresa</label><select id="empresa"></select></div>
                <div class="form-group"><label for="dpto">Departamento</label><select id="dpto"></select></div>
                <div class="form-group"><label for="unidade">Unidade</label><select id="unidade"></select></div>
                <div class="form-group"><label for="localizacao">Localização Física</label><input type="text" id="localizacao"></div>
                
                <h3 class="section-title">Condição e Descrição</h3>
                <div class="form-group"><label for="estadoBem">Estado do Bem</label><select id="estadoBem"></select></div>
                <div class="form-group"><label for="descarte">Descarte</label><select id="descarte"></select></div>
                <div class="form-group" style="grid-column: 1 / -1;"><label for="descricao">Descrição</label><textarea id="descricao" rows="3"></textarea></div>

                <h3 class="section-title">Informações Contábeis e de Compra</h3>
                <div class="form-group"><label for="classificacaoContabil">Classificação Contábil</label><select id="classificacaoContabil"></select></div>
                <div class="form-group"><label for="proprietario">Proprietário</label><input type="text" id="proprietario"></div>
                <div class="form-group"><label for="notaFiscal">Nota Fiscal</label><input type="text" id="notaFiscal"></div>
                <div class="form-group"><label for="valor">Valor (R$)</label><input type="number" id="valor" step="0.01"></div>
                <div class="form-group"><label for="dataCompra">Data da Compra</label><input type="date" id="dataCompra"></div>

                <div class="form-actions">
                    <button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display: none;">Cancelar Edição</button>
                    <button type="submit" id="submit-btn" class="btn">Salvar Ativo</button>
                </div>
            </form>
        </div>
        <div id="tab-list" class="tab-content">
            <div class="table-container">
                <table id="asset-table">
                    <thead><tr><th>Imagem</th><th>Etiqueta</th><th>Empresa</th><th>Tipo</th><th>Status Loc.</th><th>Unidade</th><th>Usuário</th><th>Localização</th><th>Ações</th></tr></thead>
                    <tbody id="asset-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="camera-modal">
        <video id="camera-feed" playsinline autoplay></video>
        <div class="modal-buttons">
            <button id="snap-photo-btn" class="btn">Tirar Foto</button>
            <button id="cancel-camera-btn" class="btn btn-danger">Cancelar</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('asset-form');
        const tableBody = document.getElementById('asset-table-body');
        const exportSystemBtn = document.getElementById('export-system-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const importSystemInput = document.getElementById('import-system-input');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const formTabBtn = document.getElementById('form-tab-btn');
        const imagePreview = document.getElementById('image-preview');
        const etiquetaInput = document.getElementById('etiqueta');
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const openCameraBtn = document.getElementById('open-camera-btn');
        const selectFileBtn = document.getElementById('select-file-btn');
        const cameraModal = document.getElementById('camera-modal');
        const cameraFeed = document.getElementById('camera-feed');
        const snapPhotoBtn = document.getElementById('snap-photo-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');

        let ativos = [];
        let editingIndex = null;
        let currentImageData = { fileName: null, dataUrl: null };
        let cameraStream = null;
        const choicesInstances = {};

        const options = {
            empresa: ['PPay', 'MNTZZ', 'VG'],
            tipoItem: ["Notebook", "Desktop", "Fonte Notebook", "Radio Comunicador", "Monitor", "Teclado", "Mouse", "Celular", "Tablet", "Carregador", "Headset", "Webcam", "Impressora", "Scanner", "Nobreak (UPS)", "Roteador", "Switch", "Servidor", "Projetor", "TV", "Mesa", "Cadeira de Escritório", "Cadeira de Reunião", "Armário", "Gaveteiro", "Estante", "Sofá", "Poltrona", "Quadro Branco", "Lixeira", "Geladeira", "Micro-ondas", "Bebedouro", "Cafeteira", "Ar Condicionado", "Ventilador", "Extintor de Incêndio", "Outro"],
            statusLocalizacao: ['Em estoque', 'Em uso', 'Em manutenção', 'Para descarte'],
            dpto: ["FACILITIES", "TI", "INFRA", "CS", "JURIDICO", "FINANCEIRO", "MARKETING", "EVENTOS", "ADM", "DIRETORIA"],
            unidade: ['TERRACINHO', 'MATRIZ', 'PO'],
            classificacaoContabil: ["Móveis e Utensílios", "Computadores e Periféricos", "Aparelhos telefônicos", "Bens de pequeno valor", "Máquinas e equipamentos", "Adornos"],
            estadoBem: ['Novo', 'Bom', 'Regular', 'Ruim', 'Sucata'],
            descarte: ['Não', 'Sim']
        };
        const formFields = ['etiqueta', 'statusLocalizacao', 'tipoItem', 'marca', 'modelo', 'nSerie', 'imei1', 'imei2', 'descricao', 'classificacaoContabil', 'localizacao', 'usuario', 'empresa', 'dpto', 'unidade', 'notaFiscal', 'valor', 'dataCompra', 'estadoBem', 'descarte', 'proprietario'];

        function initializeChoices() {
            for (const id in options) {
                const selectElement = document.getElementById(id);
                if (selectElement) {
                    choicesInstances[id] = new Choices(selectElement, {
                        choices: options[id].map(val => ({ value: val, label: val })), removeItemButton: true, searchResultLimit: 10, itemSelectText: 'Pressione para selecionar', placeholder: true, placeholderValue: 'Selecione uma opção'
                    });
                }
            }
        }
        
        async function openCamera() { try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); cameraFeed.srcObject = cameraStream; cameraModal.style.display = 'flex'; } catch (err) { alert("Não foi possível acessar a câmera. Verifique as permissões."); } }
        function closeCamera() { if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); } cameraModal.style.display = 'none'; }
        function takePicture() { const canvas = document.createElement('canvas'); canvas.width = cameraFeed.videoWidth; canvas.height = cameraFeed.videoHeight; canvas.getContext('2d').drawImage(cameraFeed, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg', 0.9); const baseName = etiquetaInput.value.trim().replace(/\s+/g, '-') || 'ativo'; currentImageData = { fileName: `${baseName}-${Date.now()}.jpg`, dataUrl: dataUrl }; imagePreview.src = dataUrl; imagePreview.style.display = 'block'; closeCamera(); }

        function dataURLtoBlob(dataurl) { let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n); while(n--){ u8arr[n] = bstr.charCodeAt(n); } return new Blob([u8arr], {type:mime}); }
        
        function renderTable() {
            tableBody.innerHTML = '';
            ativos.forEach((ativo, index) => {
                const row = document.createElement('tr');
                const imageCell = ativo.imageDataUrl ? `<a href="${ativo.imageDataUrl}" target="_blank"><img src="${ativo.imageDataUrl}" class="asset-image-thumbnail" alt="${ativo.imageFilename || ''}"></a>` : 'N/A';
                row.innerHTML = `
                    <td>${imageCell}</td><td>${ativo.etiqueta || ''}</td><td>${ativo.empresa || ''}</td>
                    <td>${ativo.tipoItem || ''}</td><td>${ativo.statusLocalizacao || ''}</td><td>${ativo.unidade || ''}</td>
                    <td>${ativo.usuario || ''}</td><td>${ativo.localizacao || ''}</td>
                    <td class="actions-cell">
                        <button class="btn btn-edit edit-btn" data-index="${index}">Editar</button>
                        <button class="btn btn-danger remove-btn" data-index="${index}">Remover</button>
                    </td>`;
                tableBody.appendChild(row);
            });
        };

        function getFormData() {
            const data = {};
            formFields.forEach(id => {
                const element = document.getElementById(id);
                if (element) data[id] = choicesInstances[id] ? choicesInstances[id].getValue(true) : element.value;
            });
            data.imageFilename = currentImageData.fileName; data.imageDataUrl = currentImageData.dataUrl;
            return data;
        };

        function setFormData(ativo) {
            formFields.forEach(id => {
                const element = document.getElementById(id);
                if (choicesInstances[id]) {
                    choicesInstances[id].clearInput();
                    if(ativo[id]) choicesInstances[id].setValue([ativo[id]]);
                    else choicesInstances[id].setValue([]);
                } else if (element) {
                    element.value = ativo[id] || '';
                }
            });
        };
        
        function handleFormSubmit(e) {
            e.preventDefault(); const ativoData = getFormData();
            if (editingIndex !== null) { ativos[editingIndex] = ativoData; alert('Ativo atualizado!'); }
            else { ativos.push(ativoData); alert('Ativo cadastrado!'); }
            resetFormMode(); renderTable();
        };

        function startEditing(index) {
            editingIndex = index; const ativo = ativos[index]; setFormData(ativo);
            currentImageData = { fileName: ativo.imageFilename, dataUrl: ativo.imageDataUrl };
            if (ativo.imageDataUrl) { imagePreview.src = ativo.imageDataUrl; imagePreview.style.display = 'block'; }
            else { imagePreview.style.display = 'none'; }
            submitBtn.textContent = 'Atualizar Ativo'; cancelEditBtn.style.display = 'inline-block';
            formTabBtn.click(); window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        function resetFormMode() {
            editingIndex = null; form.reset();
            for (const id in choicesInstances) { choicesInstances[id].setValue([]); }
            imagePreview.style.display = 'none'; imagePreview.src = '';
            currentImageData = { fileName: null, dataUrl: null };
            submitBtn.textContent = 'Salvar Ativo'; cancelEditBtn.style.display = 'none';
        };
        
        async function exportToSystem() {
            if (ativos.length === 0) return alert('Não há dados para exportar.');
            alert('Gerando arquivo ZIP, por favor aguarde...');
            const zip = new JSZip(); zip.file("backup_ativos.json", JSON.stringify(ativos, null, 2));
            const imgFolder = zip.folder("images");
            ativos.forEach(ativo => { if (ativo.imageDataUrl && ativo.imageFilename) { const blob = dataURLtoBlob(ativo.imageDataUrl); imgFolder.file(ativo.imageFilename, blob); } });
            try {
                const content = await zip.generateAsync({ type: "blob" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = `backup_completo_${new Date().toISOString().slice(0,10)}.zip`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
            } catch(e) { console.error(e); alert("Ocorreu um erro ao gerar o arquivo ZIP."); }
        };

        async function importFromSystem(e) {
            const file = e.target.files[0]; if (!file) return;
            alert('Lendo arquivo ZIP...');
            try {
                const zip = await JSZip.loadAsync(file);
                const jsonFile = zip.file("backup_ativos.json");
                if (!jsonFile) throw new Error("'backup_ativos.json' não encontrado.");
                const jsonContent = await jsonFile.async("string");
                let importedAtivos = JSON.parse(jsonContent);
                const imageMap = new Map();
                const imageFolder = zip.folder("images");
                const imagePromises = [];
                if(imageFolder) {
                    imageFolder.forEach((relativePath, zipEntry) => {
                        const promise = zipEntry.async("base64").then(base64 => {
                            const mimeType = zipEntry.name.endsWith('png') ? 'image/png' : 'image/jpeg';
                            imageMap.set(zipEntry.name, `data:${mimeType};base64,${base64}`);
                        });
                        imagePromises.push(promise);
                    });
                }
                await Promise.all(imagePromises);
                importedAtivos.forEach(ativo => { if (ativo.imageFilename && imageMap.has(ativo.imageFilename)) { ativo.imageDataUrl = imageMap.get(ativo.imageFilename); } });
                if (confirm('Dados lidos. Deseja substituir os dados atuais?')) {
                    ativos = importedAtivos;
                    resetFormMode(); renderTable();
                    alert('Sistema restaurado com sucesso!');
                }
            } catch(e) { console.error(e); alert("Erro ao importar ZIP: " + e.message); }
            e.target.value = null;
        };

        function exportToCsv() {
            if (ativos.length === 0) return alert('Não há dados para exportar.');
            alert('Gerando CSV com os nomes dos arquivos de imagem...');
            const headers = ['ETIQUETA DE PATRIMÔNIO', 'Status.localizacao', 'Tipo.item', 'Marca', 'Modelo', 'N.Série', 'IMEI.1', 'IMEI.2', 'Descrição', 'Classificação Contábil', 'Localização', 'Usuário', 'Empresa', 'Dpto', 'Unidade', 'Nota Fiscal', 'Valor', 'Data da Compra', 'Estado do bem', 'Descarte', 'Proprietário', 'Nome Arquivo Imagem'];
            const rows = ativos.map(ativo => {
                const imageName = ativo.imageFilename || ''; 
                return [
                    ativo.etiqueta, ativo.statusLocalizacao, ativo.tipoItem, ativo.marca, ativo.modelo,
                    ativo.nSerie, ativo.imei1, ativo.imei2, ativo.descricao, ativo.classificacaoContabil,
                    ativo.localizacao, ativo.usuario, ativo.empresa, ativo.dpto, ativo.unidade, ativo.notaFiscal,
                    ativo.valor, ativo.dataCompra, ativo.estadoBem, ativo.descarte, ativo.proprietario,
                    imageName
                ].map(val => `"${(val || '').toString().replace(/"/g, '""')}"`).join(';');
            });
            const csvContent = "\uFEFF" + headers.join(';') + '\n' + rows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `export_ativos_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // --- Eventos ---
        form.addEventListener('submit', handleFormSubmit);
        cancelEditBtn.addEventListener('click', resetFormMode);
        openCameraBtn.addEventListener('click', openCamera);
        cancelCameraBtn.addEventListener('click', closeCamera);
        snapPhotoBtn.addEventListener('click', takePicture);
        exportSystemBtn.addEventListener('click', exportToSystem);
        exportCsvBtn.addEventListener('click', exportToCsv);
        importSystemInput.addEventListener('change', importFromSystem);
        
        selectFileBtn.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const baseName = etiquetaInput.value.trim().replace(/\s+/g, '-') || 'ativo';
                    const uniqueFilename = `${baseName}-${Date.now()}.${file.name.split('.').pop()}`;
                    imagePreview.src = event.target.result; imagePreview.style.display = 'block';
                    currentImageData = { fileName: uniqueFilename, dataUrl: event.target.result };
                };
                reader.readAsDataURL(file);
            }
        });

        tableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) {
                if (confirm('Tem certeza?')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    ativos.splice(index, 1);
                    if (editingIndex === index) resetFormMode();
                    renderTable();
                }
            }
            if (e.target.classList.contains('edit-btn')) startEditing(parseInt(e.target.dataset.index, 10));
        });

        tabs.forEach(tab => tab.addEventListener('click', (e) => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            e.currentTarget.classList.add('active');
            document.getElementById(e.currentTarget.dataset.tab).classList.add('active');
        }));
        
        // --- Inicialização ---
        initializeChoices();
        renderTable();
    });
    </script>
</body>
</html>
