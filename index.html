<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gerenciador de Ativos</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#005C73">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --black: #000000; --tiffany-blue: #96D1D3; --midnight-green: #005C73; --teal: #01848C; --white: #f0f8ff; --shadow: rgba(0, 0, 0, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--midnight-green); color: var(--white); line-height: 1.6; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; background-color: rgba(1, 132, 140, 0.2); border-radius: 15px; box-shadow: 0 10px 30px var(--shadow); padding: 25px; backdrop-filter: blur(5px); }
        header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--tiffany-blue); padding-bottom: 15px; }
        header h1 { color: var(--tiffany-blue); font-size: 2.5rem; text-shadow: 1px 1px 3px var(--black); }
        .actions-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .btn, .btn-like-input-label { background: var(--teal); color: var(--white); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 10px var(--shadow); display: inline-block; text-align: center; }
        .btn:hover, .btn-like-input-label:hover { background: var(--tiffany-blue); color: var(--midnight-green); transform: translateY(-2px); box-shadow: 0 6px 15px var(--shadow); }
        .btn-edit { background-color: var(--tiffany-blue); color: var(--midnight-green); } .btn-edit:hover { background-color: #b0e0e6; color: var(--black); }
        .btn-danger { background-color: #c0392b; } .btn-danger:hover { background-color: #e74c3c; }
        .btn-secondary { background-color: #7f8c8d; } .btn-secondary:hover { background-color: #95a5a6; }
        input[type="file"] { display: none; }
        .tabs { display: flex; border-bottom: 2px solid var(--teal); margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; background: none; border: none; color: var(--tiffany-blue); font-size: 1.1rem; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab-button.active { color: var(--white); border-bottom-color: var(--tiffany-blue); }
        .tab-content { display: none; animation: fadeIn 0.5s; } .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #asset-form, #bulk-edit-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; color: var(--tiffany-blue); font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea, .search-input { width: 100%; padding: 10px; border: 1px solid var(--teal); background-color: rgba(0, 92, 115, 0.5); color: var(--white); border-radius: 5px; font-size: 1rem; }
        #image-preview-container { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; }
        #image-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        #image-preview { max-width: 150px; max-height: 150px; border-radius: 5px; border: 1px dashed var(--teal); display: none; }
        .form-actions { grid-column: 1 / -1; text-align: right; display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .section-title { grid-column: 1 / -1; color: var(--tiffany-blue); border-bottom: 1px solid var(--teal); padding-bottom: 5px; margin-top: 20px; font-size: 1.2rem; }
        .table-container { overflow-x: auto; }
        #asset-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #asset-table th, #asset-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--midnight-green); white-space: nowrap; }
        #asset-table th:first-child, #asset-table td:first-child { text-align: center; }
        .asset-image-thumbnail { max-width: 60px; max-height: 60px; border-radius: 5px; cursor: pointer; transition: transform 0.2s; }
        .conditional-fields { display: none; grid-column: 1 / -1; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; border: 1px dashed var(--teal); padding: 15px; border-radius: 8px; margin-top: 10px; }
        .conditional-fields.visible { display: grid; }
                .choices__inner { background-color: rgba(0, 92, 115, 0.5); border-radius: 5px; font-size: 1rem; color: var(--white); }
        .choices__list--dropdown, .choices__list[aria-expanded] { background-color: var(--midnight-green) !important; border-color: var(--teal) !important; }
        .choices__item--choice, .choices__item { color: var(--white) !important; }
        .choices__item--choice.is-highlighted, .choices__item.is-highlighted { background-color: var(--tiffany-blue) !important; color: var(--midnight-green) !important; }
        .choices__input { background-color: transparent !important; color: var(--white) !important; }
        #exit-toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--black); color: var(--white); padding: 12px 25px; border-radius: 25px; font-size: 0.9rem; z-index: 2000; }
        .list-controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        #filter-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .filter-row { display: flex; gap: 8px; align-items: center; background-color: rgba(0, 92, 115, 0.5); padding: 8px; border-radius: 8px; }
        .filter-row .choices__inner { font-size: 0.9rem; padding: 6px; min-height: auto; background-color: transparent; }
        .filter-row select, .filter-row input { border: 1px solid var(--teal); background-color: transparent; color: var(--white); border-radius: 5px; font-size: 0.9rem; padding: 8px; }
        .filter-row input { flex-grow: 1; }
        .filter-row select option { background-color: var(--midnight-green); }
        .filter-row .btn-danger { padding: 8px 12px; line-height: 1; font-size: 0.8rem; }
        #add-filter-btn { padding: 9px 15px; }
        .column-toggle-container { position: relative; }
        #column-toggle-dropdown { display: none; position: absolute; top: 100%; left: 0; background-color: var(--midnight-green); border: 1px solid var(--teal); border-radius: 8px; padding: 10px; z-index: 1002; min-width: 200px; }
        #column-toggle-dropdown.show { display: block; }
        #column-toggle-dropdown label { display: block; margin-bottom: 5px; cursor: pointer; }
        #bulk-actions-container { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        #bulk-delete-btn, #bulk-edit-btn { display: none; }
        .modal, #camera-modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--midnight-green); margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 900px; position: relative; }
        #camera-modal .modal-content { max-width: 640px; }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            header h1 {
                font-size: 2rem;
            }
            .actions-bar {
                flex-direction: column;
                gap: 10px;
            }
            .btn, .btn-like-input-label {
                width: 100%;
                padding: 15px;
            }
            .tabs {
                flex-wrap: wrap;
            }
            .tab-button {
                flex-grow: 1;
                text-align: center;
            }
            #asset-form, .conditional-fields {
                grid-template-columns: 1fr;
            }
            .form-actions {
                flex-direction: column;
            }
            .form-actions .btn {
                width: 100%;
            }
            .list-controls {
                flex-direction: column;
            }
            #filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-row > * {
                width: 100% !important;
            }
            #asset-table {
                display: block;
                width: 100%;
            }
            #asset-table thead {
                display: none;
            }
            #asset-table tbody, #asset-table tr, #asset-table td {
                display: block;
                width: 100%;
            }
            #asset-table tr {
                margin-bottom: 15px;
                border: 1px solid var(--teal);
                border-radius: 8px;
                padding: 10px;
            }
            #asset-table td {
                padding: 8px 0;
                border: none;
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: right !important;
                white-space: normal;
            }
            #asset-table td:before {
                content: attr(data-label);
                font-weight: bold;
                text-align: left;
                margin-right: 10px;
                color: var(--tiffany-blue);
            }
            #asset-table td:first-child {
                justify-content: center;
            }
            #asset-table td:first-child:before {
                content: '';
                margin-right: 0;
            }
            .asset-image-thumbnail {
                max-width: 100px;
                max-height: 100px;
            }
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Gerenciador de Ativos</h1></header>
        <div class="actions-bar">
            <button id="export-csv-btn" class="btn">Exportar CSV</button>
            <label for="import-csv-input" class="btn-like-input-label">Importar CSV (Adicionar)</label>
            <input type="file" id="import-csv-input" accept=".csv">
            <button id="export-system-btn" class="btn">Exportar Sistema (ZIP)</button>
            <label for="import-system-input" class="btn-like-input-label">Importar Sistema (ZIP)</label>
            <input type="file" id="import-system-input" accept=".zip">
        </div>
        <div class="tabs">
            <button id="form-tab-btn" class="tab-button active" data-tab="tab-form">Cadastrar Ativo</button>
            <button class="tab-button" data-tab="tab-list">Lista de Ativos</button>
        </div>

        <div id="tab-form" class="tab-content active">
            <form id="asset-form"></form>
        </div>

        <div id="tab-list" class="tab-content">
            <div class="list-controls">
                <div id="filter-controls">
                    <div id="filter-container"></div>
                    <button id="add-filter-btn" class="btn">+</button>
                    <div class="column-toggle-container">
                        <button id="column-toggle-btn" class="btn">Colunas</button>
                        <div id="column-toggle-dropdown"></div>
                    </div>
                </div>
                <div id="bulk-actions-container">
                    <button id="bulk-edit-btn" class="btn">Ação em Massa</button>
                    <button id="bulk-delete-btn" class="btn btn-danger">Excluir Selecionados</button>
                </div>
            </div>
            <div class="table-container">
                <table id="asset-table">
                    <thead id="asset-table-head"></thead>
                    <tbody id="asset-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="bulk-edit-modal" class="modal"><div class="modal-content"></div></div>
    <div id="camera-modal"></div>
    <div id="exit-toast">Pressione voltar novamente para sair</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const STORAGE_KEY = 'gerenciadorDeAtivosData';
        const VISIBILITY_KEY = 'gerenciadorDeAtivosColumnVisibility';
        const form = document.getElementById('asset-form');
        const tableHead = document.getElementById('asset-table-head');
        const tableBody = document.getElementById('asset-table-body');
        const addFilterBtn = document.getElementById('add-filter-btn');
        const filterContainer = document.getElementById('filter-container');
        const importCsvInput = document.getElementById('import-csv-input');
        const importSystemInput = document.getElementById('import-system-input');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const exportSystemBtn = document.getElementById('export-system-btn');
        const columnToggleBtn = document.getElementById('column-toggle-btn');
        const columnToggleDropdown = document.getElementById('column-toggle-dropdown');
        const cameraModal = document.getElementById('camera-modal');
        const selectAllCheckbox = document.createElement('input');
        selectAllCheckbox.type = 'checkbox';
        selectAllCheckbox.id = 'select-all-checkbox';
        selectAllCheckbox.title = 'Selecionar Todos';

        let editingIndex = null;
        let currentImageData = { fileName: null, dataUrl: null };
        let cameraStream = null;
        const choicesInstances = {};
        const bulkChoicesInstances = {};
        const filterChoicesInstances = {}; // New: Choices.js instances for filter controls
        let lastCheckedCheckbox = null;
        let activeFilters = [{}];

        const tableColumns = {
            imagem: { label: 'Imagem' },
            etiqueta: { label: 'Etiqueta' },
            empresa: { label: 'Empresa' },
            tipoItem: { label: 'Tipo' },
            marca: { label: 'Marca' },
            modelo: { label: 'Modelo' },
            nSerie: { label: 'N. Série' },
            statusLocalizacao: { label: 'Status Loc.' },
            unidade: { label: 'Unidade' },
            usuario: { label: 'Usuário' },
            descricao: { label: 'Descrição'},
            localizacao: { label: 'Localização' },
            acoes: { label: 'Ações' },
        };

        const fieldLabels = {
            etiqueta: 'Etiqueta de Patrimônio',
            tipoItem: 'Tipo do Item',
            marca: 'Marca',
            modelo: 'Modelo',
            nSerie: 'N. Série',
            imei1: 'IMEI 1',
            imei2: 'IMEI 2',
            descricao: 'Descrição',
            classificacaoContabil: 'Classificação Contábil',
            localizacao: 'Localização Física',
            usuario: 'Usuário',
            empresa: 'Empresa',
            dpto: 'Departamento',
            unidade: 'Unidade',
            notaFiscal: 'Nota Fiscal',
            valor: 'Valor (R$)',
            dataCompra: 'Data da Compra',
            estadoBem: 'Estado do Bem',
            descarte: 'Descarte',
            proprietario: 'Proprietário',
            numeroTelefone: 'Número de Telefone Vinculado',
            processador: 'Processador',
            memoriaRam: 'Memória RAM',
            memoriaRom: 'Memória ROM (Armazenamento)',
            placaDeVideo: 'Placa de Vídeo?',
            statusLocalizacao: 'Status Localização'
        };

        const loadColumnVisibility = () => {
            try {
                const stored = localStorage.getItem(VISIBILITY_KEY);
                if (stored) {
                    const loadedVisibility = JSON.parse(stored);
                    const defaultVisibility = {};
                    Object.keys(tableColumns).forEach(key => {
                        defaultVisibility[key] = loadedVisibility.hasOwnProperty(key) ? loadedVisibility[key] : true;
                    });
                    return defaultVisibility;
                }
            } catch (e) {
                console.error("Failed to load column visibility:", e);
            }
            const defaultVisibility = {};
            Object.keys(tableColumns).forEach(key => defaultVisibility[key] = true);
            return defaultVisibility;
        };

        const saveColumnVisibility = () => {
            try {
                localStorage.setItem(VISIBILITY_KEY, JSON.stringify(columnVisibility));
            } catch (e) {
                console.error("Failed to save column visibility:", e);
            }
        };

        let columnVisibility = loadColumnVisibility();

        const filterableColumns = {
            etiqueta: { label: 'Etiqueta' }, tipoItem: { label: 'Tipo' }, marca: { label: 'Marca' }, modelo: { label: 'Modelo' },
            nSerie: { label: 'N. Série' }, statusLocalizacao: { label: 'Status Loc.' }, usuario: { label: 'Usuário' }, empresa: { label: 'Empresa' },
            dpto: { label: 'Dpto' }, unidade: { label: 'Unidade' }, localizacao: { label: 'Localização' }
        };

        const options = {
            empresa: ['PPay', 'MNTZZ', 'VG'],
            tipoItem: ["Notebook", "Celular", "Desktop", "Fonte Notebook", "Radio Comunicador", "Monitor", "Apoio de Pé", "Teclado", "Mouse", "Tablet", "Carregador", "Câmera de Segurança", "Headset", "Outro"],
            statusLocalizacao: ['Em estoque', 'Em uso', 'Em manutenção', 'Para descarte'],
            dpto: ["FACILITIES", "TI", "INFRA", "CS", "JURIDICO", "FINANCEIRO", "MARKETING", "EVENTOS", "ADM", "DIRETORIA"],
            unidade: ['TERRACINHO', 'MATRIZ', 'PO'],
            classificacaoContabil: ["Móveis e Utensílios", "Computadores e Periféricos", "Aparelhos telefônicos", "Bens de pequeno valor", "Máquinas e equipamentos", "Adornos"],
            estadoBem: ['Novo', 'Bom', 'Regular', 'Ruim', 'Sucata'],
            descarte: ['Não', 'Sim'],
            processador: ['i3', 'i5', 'i7', 'Ryzen 3', 'Ryzen 5', 'Ryzen 7'],
            memoriaRam: ['4GB', '8GB', '12GB', '16GB', '32GB'],
            memoriaRom: ['128GB SSD', '256GB SSD', '512GB SSD', '1TB SSD', '500GB HDD', '1TB HDD'],
            placaDeVideo: ['Não', 'Sim']
        };
        const formFields = ['etiqueta', 'statusLocalizacao', 'tipoItem', 'marca', 'modelo', 'nSerie', 'imei1', 'imei2', 'descricao', 'classificacaoContabil', 'localizacao', 'usuario', 'empresa', 'dpto', 'unidade', 'notaFiscal', 'valor', 'dataCompra', 'estadoBem', 'descarte', 'proprietario', 'numeroTelefone', 'processador', 'memoriaRam', 'memoriaRom', 'placaDeVideo'];
        const bulkEditFields = ['tipoItem', 'marca', 'modelo', 'statusLocalizacao', 'usuario', 'empresa', 'dpto', 'unidade', 'localizacao', 'estadoBem', 'descarte', 'descricao', 'classificacaoContabil', 'proprietario', 'notaFiscal', 'valor', 'dataCompra'];

        const loadAtivos = () => { try { const data = localStorage.getItem(STORAGE_KEY); return data ? JSON.parse(data) : []; } catch (e) { console.error("Failed to load assets:", e); return []; } };
        const saveAtivos = () => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(ativos)); } catch (e) { alert("Não foi possível salvar os dados."); console.error("Failed to save assets:", e); } };
        let ativos = loadAtivos();

        function renderMainForm() {
            form.innerHTML = `
                <h3 class="section-title">Informações do Ativo</h3>
                <div class="form-group"><label for="etiqueta">Etiqueta de Patrimônio</label><input type="text" id="etiqueta" required></div>
                <div class="form-group"><label for="tipoItem">Tipo do Item</label><select id="tipoItem"></select></div>
                <div class="form-group"><label for="marca">Marca</label><input type="text" id="marca"></div>
                <div class="form-group"><label for="modelo">Modelo</label><input type="text" id="modelo"></div>
                <div class="form-group"><label for="nSerie">N. Série</label><input type="text" id="nSerie"></div>
                <div class="form-group" style="grid-column: 1 / -1;"><label>Imagem do Ativo</label><div id="image-preview-container"><div id="image-controls"><button type="button" id="open-camera-btn" class="btn">Capturar Imagem</button><label for="select-file-btn" class="btn-like-input-label">Selecionar Arquivo</label><input type="file" id="select-file-btn" accept="image/*"></div><img id="image-preview" src="" alt="Pré-visualização da Imagem"></div></div>
                <div id="celular-fields" class="conditional-fields"><h3 class="section-title">Detalhes do Celular</h3><div class="form-group"><label for="imei1">IMEI 1</label><input type="text" id="imei1"></div><div class="form-group"><label for="imei2">IMEI 2</label><input type="text" id="imei2"></div><div class="form-group"><label for="numeroTelefone">Número de Telefone Vinculado</label><input type="text" id="numeroTelefone"></div></div>
                <div id="notebook-fields" class="conditional-fields"><h3 class="section-title">Especificações do Notebook</h3><div class="form-group"><label for="processador">Processador</label><select id="processador"></select></div><div class="form-group"><label for="memoriaRam">Memória RAM</label><select id="memoriaRam"></select></div><div class="form-group"><label for="memoriaRom">Memória ROM (Armazenamento)</label><select id="memoriaRom"></select></div><div class="form-group"><label for="placaDeVideo">Placa de Vídeo?</label><select id="placaDeVideo"></select></div></div>
                <h3 class="section-title">Status e Localização</h3>
                <div class="form-group"><label for="statusLocalizacao">Status Localização</label><select id="statusLocalizacao"></select></div><div class="form-group"><label for="usuario">Usuário</label><input type="text" id="usuario"></div><div class="form-group"><label for="empresa">Empresa</label><select id="empresa"></select></div><div class="form-group"><label for="dpto">Departamento</label><select id="dpto"></select></div><div class="form-group"><label for="unidade">Unidade</label><select id="unidade"></select></div><div class="form-group"><label for="localizacao">Localização Física</label><input type="text" id="localizacao"></div>
                <h3 class="section-title">Condição e Descrição</h3>
                <div class="form-group"><label for="estadoBem">Estado do Bem</label><select id="estadoBem"></select></div><div class="form-group"><label for="descarte">Descarte</label><select id="descarte"></select></div><div class="form-group" style="grid-column: 1 / -1;"><label for="descricao">Descrição</label><textarea id="descricao" rows="3"></textarea></div>
                <h3 class="section-title">Informações Contábeis e de Compra</h3>
                <div class="form-group"><label for="classificacaoContabil">Classificação Contábil</label><select id="classificacaoContabil"></select></div><div class="form-group"><label for="proprietario">Proprietário</label><input type="text" id="proprietario"></div><div class="form-group"><label for="notaFiscal">Nota Fiscal</label><input type="text" id="notaFiscal"></div><div class="form-group"><label for="valor">Valor (R$)</label><input type="number" id="valor" step="0.01"></div><div class="form-group"><label for="dataCompra">Data da Compra</label><input type="date" id="dataCompra"></div>
                <div class="form-actions"><button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display: none;">Cancelar Edição</button><button type="submit" id="submit-btn" class="btn">Salvar Ativo</button></div>
            `;
        }

        function renderBulkEditForm() {
            const bulkEditModalContent = document.querySelector('#bulk-edit-modal .modal-content');
            if (!bulkEditModalContent) return;

            let formHtml = `
                <form id="bulk-edit-form">
                    <h3 class="section-title">Edição em Massa (<span id="bulk-edit-count"></span> ativos)</h3>
                    <p style="grid-column: 1 / -1; margin-bottom: 10px;">Preencha apenas os campos que deseja alterar nos itens selecionados. Campos em branco não serão modificados.</p>
            `;

            bulkEditFields.forEach(field => {
                const label = fieldLabels[field] || field;
                if (options[field]) {
                    formHtml += `<div class="form-group"><label for="bulk-${field}">${label}</label><select id="bulk-${field}"></select></div>`;
                } else {
                    const inputType = (field === 'valor') ? 'number' : (field === 'dataCompra') ? 'date' : 'text';
                    formHtml += `<div class="form-group"><label for="bulk-${field}">${label}</label><input type="${inputType}" id="bulk-${field}" ${inputType === 'number' ? 'step="0.01"' : ''}></div>`;
                }
            });

            formHtml += `
                    <div class="form-actions">
                        <button type="button" id="close-bulk-modal-btn" class="btn btn-secondary">Cancelar</button>
                        <button type="button" id="save-bulk-edit-btn" class="btn">Salvar Alterações</button>
                    </div>
                </form>
            `;
            bulkEditModalContent.innerHTML = formHtml;
        }

        function renderFilterControls() {
            filterContainer.innerHTML = '';
            // Destroy existing Choices.js instances for filters
            for (const key in filterChoicesInstances) {
                if (filterChoicesInstances[key]) {
                    filterChoicesInstances[key].destroy();
                    delete filterChoicesInstances[key];
                }
            }

            activeFilters.forEach((filter, index) => {
                const filterRow = document.createElement('div');
                filterRow.className = 'filter-row';
                
                const columnSelect = document.createElement('select');
                columnSelect.dataset.index = index;
                columnSelect.className = 'filter-column';
                columnSelect.innerHTML = '<option value="">Selecione a Coluna</option>' + 
                    Object.entries(filterableColumns).map(([key, {label}]) => `<option value="${key}" ${filter.column === key ? 'selected' : ''}>${label}</option>`).join('');

                let valueElement;
                const filterColumnKey = filter.column;

                if (filterColumnKey && options[filterColumnKey]) {
                    valueElement = document.createElement('select');
                    valueElement.id = `filter-value-${index}`; // Unique ID for Choices.js
                    valueElement.dataset.index = index;
                    valueElement.className = 'filter-value';
                } else {
                    valueElement = document.createElement('input');
                    valueElement.type = 'text';
                    valueElement.placeholder = 'Digite o valor para filtrar...';
                    valueElement.dataset.index = index;
                    valueElement.className = 'filter-value';
                    valueElement.value = filter.value || '';
                }

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger remove-filter-btn';
                removeBtn.textContent = 'X';
                removeBtn.dataset.index = index;

                filterRow.append(columnSelect, valueElement, removeBtn);
                filterContainer.appendChild(filterRow);

                // Initialize Choices.js for the select element if it exists
                if (filterColumnKey && options[filterColumnKey]) {
                    filterChoicesInstances[`filter-value-${index}`] = new Choices(valueElement, {
                        choices: options[filterColumnKey].map(val => ({ value: val, label: val })),
                        removeItemButton: true,
                        searchResultLimit: 15,
                        itemSelectText: 'Pressione para selecionar',
                        placeholder: true,
                        placeholderValue: 'Selecione uma opção'
                    });
                    if (filter.value) {
                        filterChoicesInstances[`filter-value-${index}`].setChoiceByValue(filter.value);
                    }
                }
            });
        }

        function renderColumnToggleUI() {
            columnToggleDropdown.innerHTML = '';
            Object.keys(tableColumns).forEach(key => {
                if (key === 'acoes') {
                    columnVisibility[key] = true;
                }
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.key = key;
                checkbox.checked = columnVisibility[key];
                if (key === 'acoes') {
                    checkbox.disabled = true;
                }
                label.appendChild(checkbox);
                label.append(` ${tableColumns[key].label}`);
                columnToggleDropdown.appendChild(label);
            });
        }

        function renderTable() {
            const visibleColumns = Object.keys(tableColumns).filter(key => columnVisibility[key]);
            
            let headerHtml = '<tr><th><input type="checkbox" id="select-all-checkbox-header"></th>';
            visibleColumns.forEach(key => {
                 headerHtml += `<th>${tableColumns[key].label}</th>`;
            });
            tableHead.innerHTML = headerHtml;

            const selectAllHeaderCheckbox = tableHead.querySelector('#select-all-checkbox-header');
            if (selectAllHeaderCheckbox) {
                selectAllHeaderCheckbox.replaceWith(selectAllCheckbox);
            }

            const filteredAtivos = ativos.filter(ativo => {
                return activeFilters.every(filter => {
                    if (!filter.column || !filter.value) return true;
                    const ativoValue = ativo[filter.column]?.toString() || ''; // Get original case for exact match
                    
                    // Check if the column is one of the dropdown types
                    if (options[filter.column]) {
                        return ativoValue === filter.value; // Exact match for dropdowns
                    } else {
                        return ativoValue.toLowerCase().includes(filter.value.toLowerCase()); // Partial match for text inputs
                    }
                });
            });

            tableBody.innerHTML = '';
            if (filteredAtivos.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="${visibleColumns.length + 1}" style="text-align:center; padding: 20px;">Nenhum ativo encontrado.</td></tr>`;
            } else {
                filteredAtivos.forEach(ativo => {
                    const originalIndex = ativos.indexOf(ativo);
                    const row = document.createElement('tr');
                    row.dataset.index = originalIndex;

                    let rowHtml = `<td data-label="Selecionar"><input type="checkbox" class="row-checkbox" data-index="${originalIndex}"></td>`;
                    
                    visibleColumns.forEach(key => {
                        let cellContent = '';
                        if (key === 'imagem') {
                            cellContent = ativo.imageDataUrl ? `<a href="${ativo.imageDataUrl}" target="_blank"><img src="${ativo.imageDataUrl}" class="asset-image-thumbnail" alt="${ativo.imageFilename || ''}"></a>` : 'N/A';
                        } else if (key === 'acoes') {
                            cellContent = `<button class="btn btn-edit edit-btn" data-index="${originalIndex}">Editar</button><button class="btn btn-danger remove-btn" data-index="${originalIndex}">Remover</button>`;
                        } else {
                            cellContent = ativo[key] || '';
                        }
                        rowHtml += `<td data-label="${tableColumns[key].label}">${cellContent}</td>`;
                    });

                    row.innerHTML = rowHtml;
                    tableBody.appendChild(row);
                });
            }
            updateBulkActionUI();
            lastCheckedCheckbox = null;
        };

        function updateBulkActionUI() { 
            const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            const anySelected = selectedCheckboxes.length > 0;
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            const bulkEditBtn = document.getElementById('bulk-edit-btn');
            if(bulkDeleteBtn) bulkDeleteBtn.style.display = anySelected ? 'inline-block' : 'none';
            if(bulkEditBtn) bulkEditBtn.style.display = anySelected ? 'inline-block' : 'none';
            if (anySelected) { 
                if(bulkDeleteBtn) bulkDeleteBtn.textContent = `Excluir ${selectedCheckboxes.length}`;
                if(bulkEditBtn) bulkEditBtn.textContent = `Ação em Massa (${selectedCheckboxes.length})`;
            }
            const allVisibleCheckboxes = document.querySelectorAll('#asset-table-body .row-checkbox');
            if (allVisibleCheckboxes.length > 0 && selectedCheckboxes.length === allVisibleCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (anySelected) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }

        function handleBulkDelete() { 
            const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked'); 
            if (selectedCheckboxes.length === 0) return;
            if (confirm(`Tem certeza que deseja excluir os ${selectedCheckboxes.length} ativos selecionados?`)) { 
                const indicesToDelete = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index, 10));
                ativos = ativos.filter((_, index) => !indicesToDelete.includes(index)); 
                saveAtivos(); 
                renderTable(); 
            }
        }
        
        function openBulkEditModal() {
            const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            if (selectedCheckboxes.length === 0) return;

            renderBulkEditForm();
            for (const key in bulkChoicesInstances) {
                if (bulkChoicesInstances[key]) {
                    bulkChoicesInstances[key].destroy();
                    delete bulkChoicesInstances[key];
                }
            }
            initializeChoices('bulk-', bulkChoicesInstances);

            document.getElementById('bulk-edit-count').textContent = selectedCheckboxes.length;
            document.getElementById('bulk-edit-modal').style.display = 'block';
        }

        function closeBulkEditModal() { 
            document.getElementById('bulk-edit-modal').style.display = 'none';
        }
        
        function handleBulkEditSave() { 
            const selectedIndices = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => parseInt(cb.dataset.index, 10)); 
            if (selectedIndices.length === 0) return; 
            let changesMade = false; 
            selectedIndices.forEach(index => { 
                const ativo = ativos[index]; 
                bulkEditFields.forEach(field => { 
                    const bulkElement = document.getElementById(`bulk-${field}`); 
                    if (!bulkElement) return; 
                    let value;
                    if (bulkChoicesInstances[`bulk-${field}`]) { 
                        value = bulkChoicesInstances[`bulk-${field}`].getValue(true);
                    } else { 
                        value = bulkElement.value; 
                    } 
                    if (value !== null && value !== undefined && value !== '') { 
                        if (ativo[field] !== value) { 
                            ativo[field] = value; 
                            changesMade = true; 
                        } 
                    } 
                }); 
            }); 
            if (changesMade) { 
                saveAtivos(); 
                renderTable(); 
                alert(`${selectedIndices.length} ativos foram atualizados!`); 
            } else { 
                alert("Nenhuma alteração foi feita."); 
            } 
            closeBulkEditModal(); 
        }

        function initializeChoices(prefix = '', instanceObject = choicesInstances) { 
            for (const id in options) { 
                const selectElement = document.getElementById(`${prefix}${id}`); 
                if (selectElement) { 
                    instanceObject[`${prefix}${id}`] = new Choices(selectElement, { 
                        choices: options[id].map(val => ({ value: val, label: val })), 
                        removeItemButton: true, 
                        searchResultLimit: 15, 
                        itemSelectText: 'Pressione para selecionar', 
                        placeholder: true, 
                        placeholderValue: 'Selecione uma opção' 
                    }); 
                } 
            } 
            const tipoItemElement = document.getElementById('tipoItem'); 
            if (tipoItemElement) { 
                tipoItemElement.addEventListener('change', toggleConditionalFields); 
            } 
        }

        function toggleConditionalFields() { 
            const tipoItemSelect = choicesInstances['tipoItem']; 
            if (!tipoItemSelect) return; 
            const tipo = tipoItemSelect.getValue(true); 
            const notebookFields = document.getElementById('notebook-fields'); 
            const celularFields = document.getElementById('celular-fields'); 
            if(notebookFields) notebookFields.classList.toggle('visible', tipo === 'Notebook'); 
            if(celularFields) celularFields.classList.toggle('visible', tipo === 'Celular'); 
        }

        function getFormData() { 
            const data = {}; 
            formFields.forEach(id => { 
                const element = document.getElementById(id); 
                if (element) data[id] = choicesInstances[id] ? choicesInstances[id].getValue(true) : element.value; 
            }); 
            data.imageFilename = currentImageData.fileName; 
            data.imageDataUrl = currentImageData.dataUrl; 
            return data; 
        };
        
        function setFormData(ativo) {
            formFields.forEach(id => {
                const element = document.getElementById(id);
                if (choicesInstances[id]) {
                    if (ativo[id]) {
                        choicesInstances[id].setChoiceByValue(String(ativo[id]));
                    } else {
                        choicesInstances[id].setChoiceByValue('');
                    }
                } else if (element) {
                    element.value = ativo[id] || '';
                }
            });
        };

        function handleFormSubmit(e) { 
            e.preventDefault(); 
            const ativoData = getFormData(); 
            if (editingIndex !== null) { 
                ativos[editingIndex] = { ...ativos[editingIndex], ...ativoData }; 
            } else { 
                ativos.push(ativoData); 
            } 
            saveAtivos(); 
            resetFormMode(); 
            renderTable(); 
            alert(editingIndex !== null ? 'Ativo atualizado!' : 'Ativo cadastrado!'); 
        };

        function startEditing(index) { 
            editingIndex = index; 
            const ativo = ativos[index]; 
            setFormData(ativo); 
            const imagePreview = document.getElementById('image-preview'); 
            currentImageData = { fileName: ativo.imageFilename, dataUrl: ativo.imageDataUrl }; 
            if (ativo.imageDataUrl) { 
                imagePreview.src = ativo.imageDataUrl; 
                imagePreview.style.display = 'block'; 
            } else { 
                imagePreview.style.display = 'none'; 
            } 
            document.getElementById('submit-btn').textContent = 'Atualizar Ativo'; 
            document.getElementById('cancel-edit-btn').style.display = 'inline-block'; 
            document.getElementById('form-tab-btn').click(); 
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
            toggleConditionalFields(); 
        };
        
        function resetFormMode() {
            editingIndex = null;
            form.reset();
            for (const id in choicesInstances) {
                if (choicesInstances[id]) choicesInstances[id].setChoiceByValue('');
            }
            const imagePreview = document.getElementById('image-preview');
            if (imagePreview) {
                imagePreview.style.display = 'none';
                imagePreview.src = '';
            }
            currentImageData = { fileName: null, dataUrl: null };
            document.getElementById('submit-btn').textContent = 'Salvar Ativo';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            toggleConditionalFields();
        };

        function escapeCsvCell(cell) {
            if (cell === null || cell === undefined) return '';
            cell = String(cell);
            if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) {
                return `"${cell.replace(/"/g, '""')}"`;
            }
            return cell;
        }

        function exportToCsv() {
            if (ativos.length === 0) {
                alert('Nenhum ativo para exportar.');
                return;
            }
            const headers = formFields.filter(f => f !== 'imageDataUrl' && f !== 'imageFilename');
            const csvRows = [headers.join(',')];

            ativos.forEach(ativo => {
                const row = headers.map(header => escapeCsvCell(ativo[header]));
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\r\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'ativos.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportSystemData() {
            if (ativos.length === 0 && Object.values(columnVisibility).every(v => v)) {
                alert('Nenhum dado para exportar.');
                return;
            }
            const zip = new JSZip();
            const appData = {
                assets: ativos,
                settings: { columnVisibility: columnVisibility }
            };
            zip.file("data.json", JSON.stringify(appData, null, 2));

            zip.generateAsync({ type: "blob" }).then(function(content) {
                const link = document.createElement('a');
                const url = URL.createObjectURL(content);
                link.setAttribute('href', url);
                link.setAttribute('download', 'gerenciador_de_ativos_backup.zip');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        function handleSystemImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            JSZip.loadAsync(file).then(function(zip) {
                const dataFile = zip.file("data.json");
                if (dataFile) {
                    dataFile.async("string").then(function(content) {
                        try {
                            const appData = JSON.parse(content);
                            if (confirm('Isso substituirá todos os dados atuais do sistema. Deseja continuar?')) {
                                ativos = appData.assets || [];
                                columnVisibility = appData.settings?.columnVisibility || loadColumnVisibility();
                                saveAtivos();
                                saveColumnVisibility();
                                renderTable();
                                renderColumnToggleUI();
                                alert('Dados do sistema importados com sucesso!');
                            }
                        } catch (e) {
                            alert('Erro ao processar o arquivo de dados (JSON inválido).');
                            console.error("JSON Parse Error:", e);
                        }
                    });
                } else {
                    alert('Arquivo de backup inválido (data.json não encontrado).');
                }
            }).catch(function(err) {
                alert('Erro ao ler o arquivo ZIP: ' + err.message);
            });
            event.target.value = '';
        }

        function handleCsvImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/);
                if (lines.length < 2) {
                    alert('CSV inválido ou vazio.');
                    return;
                }
                
                const parseCsvRow = rowString => {
                    const regex = /(?:")([^"]*(?:""[^"]*)*)(?:")|([^,]+)/g;
                    let match;
                    const result = [];
                    while (match = regex.exec(rowString)) {
                        let value = match[1] ? match[1].replace(/""/g, '"') : match[2];
                        result.push(value.trim());
                    }
                    return result;
                };

                const headers = parseCsvRow(lines[0]);
                const newAtivos = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i]) continue;
                    const values = parseCsvRow(lines[i]);
                    if (values.length === 0 || values.every(v => !v)) continue;

                    const ativo = {};
                    headers.forEach((header, index) => {
                        if (values[index] && formFields.includes(header)) {
                            ativo[header] = values[index];
                        }
                    });
                    if (Object.keys(ativo).length > 0) {
                        newAtivos.push(ativo);
                    }
                }

                if (newAtivos.length > 0) {
                    if (confirm(`Foram encontrados ${newAtivos.length} ativos no arquivo. Deseja adicioná-los à lista existente?`)) {
                        ativos.push(...newAtivos);
                        saveAtivos();
                        renderTable();
                        alert(`${newAtivos.length} ativos importados com sucesso!`);
                    }
                } else {
                    alert('Nenhum ativo válido encontrado no CSV.');
                }
                importCsvInput.value = '';
            };
            reader.readAsText(file, 'UTF-8');
        }

        function openCamera() {
            cameraModal.innerHTML = `
                <div class="modal-content">
                    <h3 class="section-title">Capturar Imagem</h3>
                    <video id="camera-stream" autoplay playsinline style="width: 100%; border-radius: 8px;"></video>
                    <div class="form-actions">
                        <button type="button" id="capture-image-btn" class="btn">Capturar</button>
                        <button type="button" id="close-camera-btn" class="btn btn-secondary">Cancelar</button>
                    </div>
                </div>
            `;
            cameraModal.style.display = 'block';

            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    cameraStream = stream;
                    const videoElement = document.getElementById('camera-stream');
                    if (videoElement) videoElement.srcObject = stream;
                })
                .catch(err => {
                    console.error("Camera Error:", err);
                    alert("Não foi possível acessar a câmera. Verifique as permissões do navegador.");
                    closeCamera();
                });
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            cameraStream = null;
            cameraModal.style.display = 'none';
            cameraModal.innerHTML = '';
        }

        function captureImage() {
            const videoElement = document.getElementById('camera-stream');
            if (!videoElement) return;

            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            canvas.getContext('2d').drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg');
            const fileName = `capture_${new Date().toISOString()}.jpg`;

            currentImageData = { fileName, dataUrl };

            const imagePreview = document.getElementById('image-preview');
            if (imagePreview) {
                imagePreview.src = dataUrl;
                imagePreview.style.display = 'block';
            }

            closeCamera();
        }

        // --- EVENT LISTENERS ---
        form.addEventListener('submit', handleFormSubmit);
        form.addEventListener('click', (e) => {
            if (e.target.id === 'cancel-edit-btn') resetFormMode();
            if (e.target.id === 'open-camera-btn') openCamera();
        });
        form.addEventListener('change', e => {
            if (e.target.id === 'select-file-btn') {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (loadEvent) => {
                        currentImageData = { fileName: file.name, dataUrl: loadEvent.target.result };
                        const imagePreview = document.getElementById('image-preview');
                        imagePreview.src = loadEvent.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        importCsvInput.addEventListener('change', handleCsvImport);
        importSystemInput.addEventListener('change', handleSystemImport);
        exportCsvBtn.addEventListener('click', exportToCsv);
        exportSystemBtn.addEventListener('click', exportSystemData);
        
        document.querySelectorAll('.tab-button').forEach(tab => tab.addEventListener('click', (e) => { 
            document.querySelector('.tab-button.active')?.classList.remove('active'); 
            document.querySelector('.tab-content.active')?.classList.remove('active'); 
            e.currentTarget.classList.add('active'); 
            document.getElementById(e.currentTarget.dataset.tab).classList.add('active'); 
            if(e.currentTarget.dataset.tab === 'tab-list') renderTable(); 
        }));

        tableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) { 
                if(confirm('Tem certeza?')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    ativos.splice(index, 1);
                    saveAtivos();
                    renderTable();
                }
            }
            if (e.target.classList.contains('edit-btn')) { startEditing(parseInt(e.target.dataset.index, 10)); }
            if (e.target.classList.contains('row-checkbox')) {
                if (e.shiftKey && lastCheckedCheckbox) {
                    const checkboxes = Array.from(tableBody.querySelectorAll('.row-checkbox'));
                    const start = checkboxes.indexOf(lastCheckedCheckbox);
                    const end = checkboxes.indexOf(e.target);
                    const range = (start < end) ? checkboxes.slice(start, end + 1) : checkboxes.slice(end, start + 1);
                    range.forEach(checkbox => checkbox.checked = lastCheckedCheckbox.checked);
                }
                lastCheckedCheckbox = e.target;
                updateBulkActionUI();
            }
        });

        selectAllCheckbox.addEventListener('click', (e) => { 
            document.querySelectorAll('#asset-table-body .row-checkbox').forEach(checkbox => { 
                checkbox.checked = e.target.checked; 
            }); 
            updateBulkActionUI(); 
        });

        document.getElementById('bulk-delete-btn')?.addEventListener('click', handleBulkDelete);
        document.getElementById('bulk-edit-btn')?.addEventListener('click', openBulkEditModal);

        document.getElementById('bulk-edit-modal').addEventListener('click', (e) => {
            if (e.target.id === 'close-bulk-modal-btn') closeBulkEditModal();
            if (e.target.id === 'save-bulk-edit-btn') handleBulkEditSave();
        });

        cameraModal.addEventListener('click', (e) => {
            if (e.target.id === 'capture-image-btn') captureImage();
            if (e.target.id === 'close-camera-btn') closeCamera();
        });

        addFilterBtn.addEventListener('click', () => {
            activeFilters.push({});
            renderFilterControls();
        });

        filterContainer.addEventListener('click', e => {
            if (e.target.classList.contains('remove-filter-btn')) {
                activeFilters.splice(e.target.dataset.index, 1);
                if (activeFilters.length === 0) activeFilters.push({});
                renderFilterControls();
                renderTable();
            }
        });

        filterContainer.addEventListener('change', e => {
            const index = e.target.dataset.index;
            if (e.target.classList.contains('filter-column')) {
                activeFilters[index].column = e.target.value;
                activeFilters[index].value = ''; // Reset value
                renderFilterControls(); // Re-render to get correct input
                renderTable();
            } else if (e.target.classList.contains('filter-value')) {
                // Handle both native select and Choices.js select
                const choicesInstance = filterChoicesInstances[`filter-value-${index}`];
                activeFilters[index].value = choicesInstance ? choicesInstance.getValue(true) : e.target.value;
                renderTable();
            }
        });

        filterContainer.addEventListener('input', e => {
            if (e.target.classList.contains('filter-value') && e.target.tagName === 'INPUT') {
                activeFilters[e.target.dataset.index].value = e.target.value;
                renderTable();
            }
        });

        columnToggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            columnToggleDropdown.classList.toggle('show');
        });

        columnToggleDropdown.addEventListener('change', (e) => {
            const key = e.target.dataset.key;
            if (key) {
                columnVisibility[key] = e.target.checked;
                saveColumnVisibility();
                renderTable();
            }
        });

        document.addEventListener('click', (e) => {
            if (!columnToggleDropdown.contains(e.target) && e.target !== columnToggleBtn) {
                columnToggleDropdown.classList.remove('show');
            }
        });

        // --- INICIALIZAÇÃO ---
        renderMainForm();
        initializeChoices('', choicesInstances);
        renderFilterControls();
        renderColumnToggleUI();
        renderTable();
    });
    </script>
</body>
</html>